function parseArgv(e){Nomnom.script("fire").option("project",{position:0,help:"The fireball project file."}).option("version",{abbr:"v",flag:!0,help:"Print the version.",callback:function(){return FIRE_VER}}).option("help",{abbr:"h",flag:!0,help:"Print this usage message."}).option("dev",{abbr:"d",flag:!0,help:"Run in development mode."}).option("showDevtools",{abbr:"D",full:"show-devtools",flag:!0,help:"Open devtools automatically when main window loaded."}).option("debug",{full:"debug",flag:!0,help:"Open in browser context debug mode."}).option("debugBreak",{full:"debug-brk",flag:!0,help:"Open in browser context debug mode, and break at first."}).option("disableDirectWrite",{full:"disable-direct-write",flag:!0,help:"Disables the DirectWrite font rendering system on windows."});var r=Nomnom.parse(e);return r.dev&&(r.project=r._.length<2?null:r._[r._.length-1]),r}function _fireurl(e){var r=Url.parse(e),o="";switch(r.protocol){case"fire:":return o=e.substr(7),Path.join(FIRE_PATH,o);case"editor-core:":return o=e.substr(14),Path.join(FIRE_PATH,"src/editor-core/",o);case"assets:":return Fire.AssetDB.fspath(e);default:return e}}function _getProfilePath(e,r){return"global"===r?Path.join(FIRE_DATA_PATH,"settings",e+".json"):"project"===r?Path.join(FIRE_PROJECT_PATH,"settings",e+".json"):"local"===r?Path.join(FIRE_PROJECT_PATH,"local",e+".json"):""}function _saveProfile(e,r,o){var i=_getProfilePath(e,r),t=JSON.stringify(o,null,2);Fs.writeFileSync(i,t,"utf8")}function _loadProfile(e,r,o){var i=e+"@"+r,t=_profiles[i];if(t)return t;var n={save:function(){_saveProfile(e,r,this)},clear:function(){for(var e in this)"save"!==e&&"clear"!==e&&delete this[e]}},a=_getProfilePath(e,r);if(t=o||{},Fs.existsSync(a))try{t=JSON.parse(Fs.readFileSync(a))}catch(l){l&&(Fire.warn("Failed to load profile %s, error message: %s",e,l.message),t={})}else Fs.writeFileSync(a,JSON.stringify(t,null,2));return t=Fire.JS.mixin(t,n),_profiles[i]=t,t}function registerProtocol(){Winston.normal("Register protocol");var e=require("protocol");e.registerProtocol("fire",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Path.join(FIRE_PATH,t);return new e.RequestFileJob(n)}),e.registerProtocol("library",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Path.join(Fire.AssetDB.getLibraryPath(),t),a=new e.RequestFileJob(n);return a}),e.registerProtocol("uuid",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Fire.AssetDB.uuidToLibraryPath(t);if("thumb"===i.query){var a=Fire.AssetDB.uuidToFspath(t);n=n+".thumb"+Path.extname(a)}return new e.RequestFileJob(n)})}function initFireApp(){Winston.normal("Initializing Fire"),global.Fire=require("./src/core/core"),Fire.JS.mixin(global.Fire,require("./src/editor-share/editor-share")),global.Fire.url=_fireurl,global.Fire.loadProfile=_loadProfile,Fire.loadProfile("fireball","global",{recentlyOpened:[]});var e=require(Fire.url("editor-core://fire-app"));new e}function start(){var e=parseArgv(process.argv.slice(1));App.on("window-all-closed",function(){App.quit()}),App.on("open-file",function(){}),App.on("open-url",function(){}),App.on("will-finish-launching",function(){if(!e.dev){var r=require("crash-reporter");r.start({productName:"Fireball",companyName:"FireBox",submitUrl:"https://fireball-x.im/crash-report",autoSubmit:!1})}}),e.disableDirectWrite&&App.commandLine.appendSwitch("disable-direct-write"),App.on("ready",function(){registerProtocol(),initFireApp(),Fire.info("Welcome to Fireball! The next-gen html5 game engine.");try{if(e.project){var r=require(Fire.url("editor-core://fireball"));r.open(e)}else{var o=require(Fire.url("editor-core://dashboard"));o.open()}}catch(i){Winston.error(i.stack||i),App.terminate()}})}global.shellStartTime=Date.now();var App=require("app"),Path=require("fire-path"),Fs=require("fire-fs"),Url=require("fire-url"),Nomnom=require("nomnom"),Chalk=require("chalk"),Winston=require("winston");global.FIRE_VER="0.1.7",global.FIRE_PATH=__dirname,global.FIRE_DATA_PATH=Path.join(App.getPath("home"),".fireball"),global.FIRE_PROJECT_PATH="",global.Fire={},process.removeAllListeners("uncaughtException"),process.on("uncaughtException",function(e){Fire.sendToWindows&&Fire.sendToWindows("console:error",e.stack||e),Winston.uncaught(e.stack||e)}),Fs.existsSync(global.FIRE_DATA_PATH)||Fs.makeTreeSync(global.FIRE_DATA_PATH);var settingsPath=Path.join(global.FIRE_DATA_PATH,"settings");Fs.existsSync(settingsPath)||Fs.mkdirSync(settingsPath);var _logpath="";_logpath="darwin"===process.platform?Path.join(App.getPath("home"),"Library/Logs/Fireball"):App.getPath("appData"),Fs.existsSync(_logpath)||Fs.makeTreeSync(_logpath);var _logfile=Path.join(_logpath,"fireball.log");Fs.existsSync(_logfile)&&Fs.unlinkSync(_logfile);var winstonLevels={normal:0,success:1,failed:2,info:3,warn:4,error:5,fatal:6,uncaught:7};Winston.setLevels(winstonLevels),Winston.remove(Winston.transports.Console),Winston.add(Winston.transports.File,{level:"normal",filename:_logfile,json:!1});var chalk_id=Chalk.bgBlue,chalk_success=Chalk.green,chalk_warn=Chalk.yellow,chalk_error=Chalk.red,chalk_info=Chalk.cyan,levelToFormat={normal:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+e},success:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_success(e)},failed:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error(e)},info:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_info(e)},warn:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_warn.inverse.bold("Warning:")+" "+chalk_warn(e)},error:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Error:")+" "+chalk_error(e)},fatal:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Fatal Error:")+" "+chalk_error(e)},uncaught:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Uncaught Exception:")+" "+chalk_error(e)}};Winston.add(Winston.transports.Console,{level:"normal",formatter:function(e){var r=(chalk_id("["+process.pid+"]")+" ","");void 0!==e.message&&(r+=e.message),e.meta&&Object.keys(e.meta).length&&(r+=" "+JSON.stringify(e.meta));var o=levelToFormat[e.level];return o?o(r):r}});var _profiles={};start();