function parseArgv(e){Nomnom.script("fire").option("project",{position:0,help:"The fireball project file."}).option("version",{abbr:"v",flag:!0,help:"Print the version.",callback:function(){return FIRE_VER}}).option("help",{abbr:"h",flag:!0,help:"Print this usage message."}).option("dev",{abbr:"d",flag:!0,help:"Run in development mode."}).option("showDevtools",{abbr:"D",full:"show-devtools",flag:!0,help:"Open devtools automatically when main window loaded."}).option("debug",{full:"debug",flag:!0,help:"Open in browser context debug mode."}).option("debugBreak",{full:"debug-brk",flag:!0,help:"Open in browser context debug mode, and break at first."}).option("disableDirectWrite",{full:"disable-direct-write",flag:!0,help:"Disables the DirectWrite font rendering system on windows."});var r=Nomnom.parse(e);return r.dev&&(r.project=r._.length<2?null:r._[r._.length-1],global.FIRE_DATA_PATH=__dirname),r}function fireurl(e){var r=Url.parse(e),o="";switch(r.protocol){case"fire:":return o=e.substr(7),Path.join(FIRE_PATH,o);case"editor-core:":return o=e.substr(14),Path.join(FIRE_PATH,"src/editor-core/",o);case"assets:":return Fire.AssetDB.fspath(e);default:return e}}function saveProfile(){var e=Path.join(FIRE_DATA_PATH,"profile.json");Fs.writeFileSync(e,JSON.stringify(Fire.userProfile,null,4))}function registerProtocol(){console.log("Register protocol");var e=require("protocol");e.registerProtocol("fire",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Path.join(FIRE_PATH,t);return new e.RequestFileJob(n)}),e.registerProtocol("library",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Path.join(Fire.AssetDB.getLibraryPath(),t),a=new e.RequestFileJob(n);return a}),e.registerProtocol("uuid",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),t=i.hostname;i.pathname&&(t=Path.join(t,i.pathname));var n=Fire.AssetDB.uuidToLibraryPath(t);if("thumb"===i.query){var a=Fire.AssetDB.uuidToFspath(t);n=n+".thumb"+Path.extname(a)}return new e.RequestFileJob(n)})}function initFireApp(){console.log("Initializing Fire"),global.Fire=require("./src/core/core"),global.Fire=Fire.mixin(global.Fire,require("./src/editor-share/editor-share")),global.Fire.url=fireurl,global.Fire.saveProfile=saveProfile,global.Fire.Console=require(Fire.url("editor-core://fire-console")),console.log("Loading user profile");var e=Path.join(FIRE_DATA_PATH,"profile.json");Fs.existsSync(e)?Fire.userProfile=JSON.parse(Fs.readFileSync(e)):(Fire.userProfile={recentlyOpened:[]},Fs.writeFileSync(e,JSON.stringify(Fire.userProfile,null,4)));var r=require(Fire.url("editor-core://fire-app"));new r}function start(){_options=parseArgv(process.argv.slice(1)),App.on("window-all-closed",function(){App.quit()}),App.on("open-file",function(){}),App.on("open-url",function(){}),App.on("will-finish-launching",function(){if(!_options.dev){var e=require("crash-reporter");e.start({productName:"Fireball-x",companyName:"FireBox",submitUrl:"https://fireball-x.im/crash-report",autoSubmit:!1})}}),_options.disableDirectWrite&&App.commandLine.appendSwitch("disable-direct-write"),App.on("ready",function(){registerProtocol(),initFireApp(),Fire.info("Welcome to Fireball-x! The next-gen html5 game engine.");try{if(_options.project){var e=require(Fire.url("editor-core://fireball"));e.open(_options)}else{var r=require(Fire.url("editor-core://dashboard"));r.open()}}catch(o){Fire.Console.error(o.stack||o),App.terminate()}})}global.shellStartTime=Date.now();var App=require("app"),Path=require("fire-path"),Fs=require("fire-fs"),Url=require("fire-url"),Nomnom=require("nomnom"),Chalk=require("chalk");global.FIRE_VER="0.1.3",global.FIRE_PATH=__dirname,global.FIRE_DATA_PATH=App.getPath("userData"),global.FIRE_PROJECT_PATH="",global.Fire={};var _options={};process.removeAllListeners("uncaughtException"),process.on("uncaughtException",function(e){Fire&&Fire.error?(Fire.error(e.message),console.error(Chalk.red(e.stack||e))):console.error(Chalk.red.inverse.bold("Error:")+" "+Chalk.red(e.stack||e))}),start();