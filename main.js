function parseArgv(e){Nomnom.script("fire").option("project",{position:0,help:"The fireball project file."}).option("version",{abbr:"v",flag:!0,help:"Print the version.",callback:function(){return FIRE_VER}}).option("help",{abbr:"h",flag:!0,help:"Print this usage message."}).option("dev",{abbr:"d",flag:!0,help:"Run in development mode."}).option("showDevtools",{abbr:"D",full:"show-devtools",flag:!0,help:"Open devtools automatically when main window loaded."}).option("debug",{full:"debug",flag:!0,help:"Open in browser context debug mode."}).option("debugBreak",{full:"debug-brk",flag:!0,help:"Open in browser context debug mode, and break at first."}).option("disableDirectWrite",{full:"disable-direct-write",flag:!0,help:"Disables the DirectWrite font rendering system on windows."});var r=Nomnom.parse(e);return r.dev&&(r.project=r._.length<2?null:r._[r._.length-1],global.FIRE_DATA_PATH=__dirname),r}function fireurl(e){var r=Url.parse(e),o="";switch(r.protocol){case"fire:":return o=e.substr(7),Path.join(FIRE_PATH,o);case"editor-core:":return o=e.substr(14),Path.join(FIRE_PATH,"src/editor-core/",o);case"assets:":return Fire.AssetDB.fspath(e);default:return e}}function saveProfile(){var e=Path.join(FIRE_DATA_PATH,"profile.json");Fs.writeFileSync(e,JSON.stringify(Fire.userProfile,null,4))}function registerProtocol(){Winston.normal("Register protocol");var e=require("protocol");e.registerProtocol("fire",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),n=i.hostname;i.pathname&&(n=Path.join(n,i.pathname));var t=Path.join(FIRE_PATH,n);return new e.RequestFileJob(t)}),e.registerProtocol("library",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),n=i.hostname;i.pathname&&(n=Path.join(n,i.pathname));var t=Path.join(Fire.AssetDB.getLibraryPath(),n),a=new e.RequestFileJob(t);return a}),e.registerProtocol("uuid",function(r){var o=decodeURIComponent(r.url),i=Url.parse(o),n=i.hostname;i.pathname&&(n=Path.join(n,i.pathname));var t=Fire.AssetDB.uuidToLibraryPath(n);if("thumb"===i.query){var a=Fire.AssetDB.uuidToFspath(n);t=t+".thumb"+Path.extname(a)}return new e.RequestFileJob(t)})}function initFireApp(){Winston.normal("Initializing Fire"),global.Fire=require("./src/core/core"),global.Fire=Fire.JS.mixin(global.Fire,require("./src/editor-share/editor-share")),global.Fire.url=fireurl,global.Fire.saveProfile=saveProfile,Winston.normal("Loading user profile");var e=Path.join(FIRE_DATA_PATH,"profile.json");Fs.existsSync(e)?Fire.userProfile=JSON.parse(Fs.readFileSync(e)):(Fire.userProfile={recentlyOpened:[]},Fs.writeFileSync(e,JSON.stringify(Fire.userProfile,null,4)));var r=require(Fire.url("editor-core://fire-app"));new r}function start(){_options=parseArgv(process.argv.slice(1)),App.on("window-all-closed",function(){App.quit()}),App.on("open-file",function(){}),App.on("open-url",function(){}),App.on("will-finish-launching",function(){if(!_options.dev){var e=require("crash-reporter");e.start({productName:"Fireball",companyName:"FireBox",submitUrl:"https://fireball-x.im/crash-report",autoSubmit:!1})}}),_options.disableDirectWrite&&App.commandLine.appendSwitch("disable-direct-write"),App.on("ready",function(){registerProtocol(),initFireApp(),Fire.info("Welcome to Fireball! The next-gen html5 game engine.");try{if(_options.project){var e=require(Fire.url("editor-core://fireball"));e.open(_options)}else{var r=require(Fire.url("editor-core://dashboard"));r.open()}}catch(o){Winston.error(o.stack||o),App.terminate()}})}global.shellStartTime=Date.now();var App=require("app"),Path=require("fire-path"),Fs=require("fire-fs"),Url=require("fire-url"),Nomnom=require("nomnom"),Chalk=require("chalk"),Winston=require("winston");global.FIRE_VER="0.1.5",global.FIRE_PATH=__dirname,global.FIRE_DATA_PATH=App.getPath("userData"),global.FIRE_PROJECT_PATH="",global.Fire={};var _options={},_logpath="";_logpath="darwin"===process.platform?Path.join(App.getPath("home"),"Library/Logs/Fireball"):App.getPath("appData"),process.removeAllListeners("uncaughtException"),process.on("uncaughtException",function(e){Winston.uncaught(e.stack||e)}),Fs.existsSync(_logpath)||Fs.makeTreeSync(_logpath);var _logfile=Path.join(_logpath,"fireball.log");Fs.existsSync(_logfile)&&Fs.unlinkSync(_logfile);var winstonLevels={normal:0,success:1,failed:2,info:3,warn:4,error:5,fatal:6,uncaught:7};Winston.setLevels(winstonLevels),Winston.remove(Winston.transports.Console),Winston.add(Winston.transports.File,{level:"normal",filename:_logfile,json:!1});var chalk_id=Chalk.bgBlue,chalk_success=Chalk.green,chalk_warn=Chalk.yellow,chalk_error=Chalk.red,chalk_info=Chalk.cyan,levelToFormat={normal:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+e},success:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_success(e)},failed:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error(e)},info:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_info(e)},warn:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_warn.inverse.bold("Warning:")+" "+chalk_warn(e)},error:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Error:")+" "+chalk_error(e)},fatal:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Fatal Error:")+" "+chalk_error(e)},uncaught:function(e){var r=chalk_id("["+process.pid+"]")+" ";return r+chalk_error.inverse.bold("Uncaught Exception:")+" "+chalk_error(e)}};Winston.add(Winston.transports.Console,{level:"normal",formatter:function(e){var r=(chalk_id("["+process.pid+"]")+" ","");void 0!==e.message&&(r+=e.message),e.meta&&Object.keys(e.meta).length&&(r+=" "+JSON.stringify(e.meta));var o=levelToFormat[e.level];return o?o(r):r}}),start();