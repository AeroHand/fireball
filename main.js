var App=require("app"),Path=require("fire-path"),Fs=require("fire-fs"),Url=require("fire-url"),Commander=require("commander"),Chalk=require("chalk"),Winston=require("winston");process.removeAllListeners("uncaughtException"),process.on("uncaughtException",function(r){Editor&&Editor.sendToWindows&&Editor.sendToWindows("console:error",r.stack||r),Winston.uncaught(r.stack||r)}),global.Editor={},global.Fire={},Editor.name=App.getName(),Editor.cwd=__dirname,Editor.dataPath=Path.join(App.getPath("home"),"."+Editor.name),Fs.existsSync(Editor.dataPath)||Fs.makeTreeSync(Editor.dataPath);var settingsPath=Path.join(Editor.dataPath,"settings");Fs.existsSync(settingsPath)||Fs.mkdirSync(settingsPath),Editor.App=require("./app.js");var _logpath="";_logpath="darwin"===process.platform?Path.join(App.getPath("home"),"Library/Logs/"+Editor.name):App.getPath("appData"),Fs.existsSync(_logpath)||Fs.makeTreeSync(_logpath);var _logfile=Path.join(_logpath,Editor.name+".log");Fs.existsSync(_logfile)&&Fs.unlinkSync(_logfile);var winstonLevels={normal:0,success:1,failed:2,info:3,warn:4,error:5,fatal:6,uncaught:7};Winston.setLevels(winstonLevels),Winston.remove(Winston.transports.Console),Winston.add(Winston.transports.File,{level:"normal",filename:_logfile,json:!1});var chalk_id=Chalk.bgBlue,chalk_success=Chalk.green,chalk_warn=Chalk.yellow,chalk_error=Chalk.red,chalk_info=Chalk.cyan,levelToFormat={normal:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+r},success:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_success(r)},failed:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_error(r)},info:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_info(r)},warn:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_warn.inverse.bold("Warning:")+" "+chalk_warn(r)},error:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_error.inverse.bold("Error:")+" "+chalk_error(r)},fatal:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_error.inverse.bold("Fatal Error:")+" "+chalk_error(r)},uncaught:function(r){var e=chalk_id("["+process.pid+"]")+" ";return e+chalk_error.inverse.bold("Uncaught Exception:")+" "+chalk_error(r)}};Winston.add(Winston.transports.Console,{level:"normal",formatter:function(r){var e=(chalk_id("["+process.pid+"]")+" ","");void 0!==r.message&&(e+=r.message),r.meta&&Object.keys(r.meta).length&&(e+=" "+JSON.stringify(r.meta));var o=levelToFormat[r.level];return o?o(e):e}}),Commander.version(App.getVersion()).option("--dev","Run in development mode").option("--show-devtools","Open devtools automatically when main window loaded").option("--debug <port>","Open in browser context debug mode",parseInt).option("--debug-brk <port>","Open in browser context debug mode, and break at first.",parseInt),Editor.App.initCommander&&Editor.App.initCommander(Commander),Commander.parse(process.argv),Editor.isDev=Commander.dev,Editor.showDevtools=Commander.showDevtools,App.on("window-all-closed",function(){App.quit()}),App.on("will-finish-launching",function(){}),App.on("ready",function(){if(Winston.normal("Initializing protocol"),require("./src/editor-core/protocol-init"),Winston.normal("Initializing editor"),require("./src/editor-core/editor-init"),require("./src/editor-core/ipc-init"),Editor.registerProfilePath("global",Path.join(Editor.dataPath,"settings")),Editor.registerProfilePath("local",Path.join(Editor.dataPath,"settings")),!Editor.App.init)return Winston.error('Can not find function "init" in your App'),void App.terminate();try{Editor.App.init(Commander)}catch(r){return Winston.error(r.stack||r),void App.terminate()}if(Winston.success("Initial success!"),!Editor.App.run)return Winston.error('Can not find function "run" in your App'),void App.terminate();try{Editor.App.run()}catch(r){return Winston.error(r.stack||r),void App.terminate()}});