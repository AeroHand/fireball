<html><head></head><body><div hidden=""><polymer-element name="scene-view" constructor="SceneView" on-mousemove="{{mousemoveAction}}" on-mousedown="{{mousedownAction}}" on-mousewheel="{{mousewheelAction}}" on-mouseleave="{{mouseleaveAction}}" on-gizmoshover="{{gizmoshoverAction}}" on-gizmosdirty="{{gizmosdirtyAction}}" on-dragover="{{dragoverAction}}" on-drop="{{dropAction}}" assetpath=""><template><style>:host{display:block;}:host(:focus){outline:0}svg{position:absolute;top:0;right:0;bottom:0;left:0}#grids{shape-rendering:crispEdges}#gizmos{shape-rendering:geometricPrecision}canvas{position:absolute;top:0;right:0;bottom:0;left:0}</style><canvas id="canvas"></canvas><svg id="gizmos"></svg></template><script>!function(){Polymer("scene-view",{created:function(){this.renderContext=null,this.pixiGrids=null,this.svgGizmos=null,this.view={width:0,height:0},this.sceneCamera={position:{x:0,y:0},scale:1},this.ipc=new Fire.IpcListener,this._editTool=null,this._editingEdityIds=[]},ready:function(){this.tabIndex=EditorUI.getParentTabIndex(this)+1,this.pixiGrids=new Fire.PixiGrids,this.svgGizmos=new Fire.SvgGizmos(this.$.gizmos)},attached:function(){this.ipc.on("component:enabled",this.updateComponent.bind(this,!0)),this.ipc.on("component:disabled",this.updateComponent.bind(this,!1))},detached:function(){this.ipc.clear()},init:function(){var a=this.getBoundingClientRect();if(this.view={left:a.left,top:a.top,width:a.width,height:a.height},this.interactionContext=Fire.Engine.createInteractionContext(),this.renderContext=Fire.Engine.createSceneView(this.view.width,this.view.height,this.$.canvas),null!==this.renderContext){var b=new PIXI.Graphics;this.renderContext.getBackgroundNode().addChild(b),this.pixiGrids.setGraphics(b),this.initSceneCamera(),this.resize()}},initSceneCamera:function(){if(Fire.Engine._scene){var a=null,b=Fire.Engine._scene.findEntityWithFlag("/Scene Camera",Fire._ObjectFlags.Hide|Fire._ObjectFlags.EditorOnly);if(null===b)b=new Fire.Entity.createWithFlags("Scene Camera",Fire._ObjectFlags.Hide|Fire._ObjectFlags.EditorOnly),a=b.addComponent(Fire.Camera);else if(a=b.getComponent(Fire.Camera),null===a)return void Fire.error("Can not find camera component in Scene Camera.");a.size=this.view.height,this.renderContext.camera=a,this.svgGizmos.setCamera(a),this.pixiGrids.setCamera(a)}},resize:function(){if(null!==this.renderContext){var a=this.getBoundingClientRect();this.view={left:a.left,top:a.top,width:a.width,height:a.height},this.renderContext.size=new Fire.Vec2(this.view.width,this.view.height),this.pixiGrids.resize(this.view.width,this.view.height),this.svgGizmos.resize(this.view.width,this.view.height),this.repaint()}},repaint:function(){this.updateCamera(),this.updateScene(),this.updateGizmos()},updateCamera:function(){Fire.Engine._scene&&this.renderContext&&(this.renderContext.camera.size=this.view.height/this.sceneCamera.scale,this.renderContext.camera.transform.position=new Vec2(this.sceneCamera.position.x,this.sceneCamera.position.y))},updateScene:function(){Fire.Engine._scene&&this.renderContext&&(this.pixiGrids.update(),Fire.Engine._scene.render(this.renderContext),this.interactionContext.update(Fire.Engine._scene.entities))},updateGizmos:function(){Fire.Engine._scene&&this.renderContext&&this.svgGizmos.update()},rebuildGizmos:function(){this._editingEdityIds.length>0&&(this._editTool&&this.svgGizmos.remove(null,this._editTool),this.edit(this._editingEdityIds))},updateComponent:function(a,b){var c=null;if(a){var d=Fire._getInstanceById(b);if(!d)return;if(d.entity._objFlags&Fire._ObjectFlags.HideInEditor)return;var e=Fire.getClassName(d),f=Fire.gizmos[e];f&&(c=new f(this.svgGizmos,d),c.update(),this.svgGizmos.add(b,c))}else c=this.svgGizmos.gizmosTable[b],c&&this.svgGizmos.remove(b,c)},updateComponentGizmos:function(a,b){for(var c=0;c<a._components.length;++c){var d=a._components[c];if(d.isValid){var e=this.svgGizmos.gizmosTable[d.id];e&&(Fire.mixin(e,b),e.update())}}},hover:function(a){var b=Fire._getInstanceById(a);b&&this.updateComponentGizmos(b,{hovering:!0})},hoverout:function(a){var b=Fire._getInstanceById(a);b&&this.updateComponentGizmos(b,{hovering:!1})},select:function(a){this._editTool&&(this.svgGizmos.remove(null,this._editTool),this._editTool=null),this._editingEdityIds=this._editingEdityIds.concat(a),this._editingEdityIds.length>0&&this.edit(this._editingEdityIds)},unselect:function(a){for(var b=0;b<a.length;++b){for(var c=a[b],d=0;d<this._editingEdityIds.length;++d)if(this._editingEdityIds[d]===c){this._editingEdityIds.splice(d,1);break}var e=Fire._getInstanceById(a[b]);e&&this.updateComponentGizmos(e,{selecting:!1,editing:!1})}this._editTool&&(this.svgGizmos.remove(null,this._editTool),this._editTool=null),this._editingEdityIds.length>0&&this.edit(this._editingEdityIds)},edit:function(a){var b,c,d=[],e=null;for(b=0;b<a.length;++b)e=Fire._getInstanceById(a[b]),e&&d.push(e);switch(Fire.mainWindow.settings.handle){case"move":c=new Fire.PositionGizmo(this.svgGizmos,d);break;case"rotate":c=new Fire.RotationGizmo(this.svgGizmos,d);break;case"scale":c=new Fire.ScaleGizmo(this.svgGizmos,d)}c.hitTest=!1,c.pivot=Fire.mainWindow.settings.pivot,c.coordinate=Fire.mainWindow.settings.coordinate,c.update(),this._editTool=c,this.svgGizmos.add(null,c);var f,g;if(1===d.length)for(e=d[0],f=0;f<e._components.length;++f)g=e._components[f],g.isValid&&(c=this.svgGizmos.gizmosTable[g.id],!c||c.selecting!==!1&&c.editing!==!1||(c.selecting=!0,c.editing=!0,c.update()));else for(b=0;b<d.length;++b)for(e=d[b],f=0;f<e._components.length;++f)g=e._components[f],g.isValid&&(c=this.svgGizmos.gizmosTable[g.id],!c||c.selecting!==!1&&c.editing!==!0||(c.selecting=!0,c.editing=!1,c.update()))},hitTest:function(a,b){if(!this.renderContext)return null;var c=this.svgGizmos.hitTest(a,b,1,1);if(c.length>0)return c[0].entity;for(var d=new Fire.Vec2(a,b),e=this.renderContext.camera.screenToWorld(d),f=Number.MAX_VALUE,g=null,h=0,i=this.interactionContext.entities;h<i.length;++h){var j=i[h],k=this.interactionContext.getAABB(j);if(k.contains(e)){var l=e.sub(k.center).magSqr();if(f>l){var m=this.interactionContext.getOBB(j),n=new Fire.Polygon(m);n.contains(e)&&(f=l,g=j)}}}return g},rectHitTest:function(a){var b=this.renderContext.camera.screenToWorld(new Fire.Vec2(a.x,a.y)),c=this.renderContext.camera.screenToWorld(new Fire.Vec2(a.xMax,a.yMax)),d=Fire.Rect.fromVec2(b,c),e=[],f,g;for(f=0,g=this.interactionContext.entities;f<g.length;++f){var h=g[f],i=this.interactionContext.getAABB(h);if(i.intersects(d)){var j=this.interactionContext.getOBB(h),k=new Fire.Polygon(j);Fire.Intersection.rectPolygon(d,k)&&e.push(h)}}var l=this.svgGizmos.hitTest(a.x,a.y,a.width,a.height);for(f=0;f<l.length;++f)e.push(l[f].entity);return e},mousemoveAction:function(a){var b=this.hitTest(a.offsetX,a.offsetY);Fire.Selection.hoverEntity(b&&b.id),a.stopPropagation()},mousedownAction:function(a){if(1===a.which&&a.shiftKey){var b=function(a){var b=a.clientX-this._lastClientX,c=a.clientY-this._lastClientY;this.sceneCamera.position.x=this.sceneCamera.position.x-b/this.sceneCamera.scale,this.sceneCamera.position.y=this.sceneCamera.position.y+c/this.sceneCamera.scale,this._lastClientX=a.clientX,this._lastClientY=a.clientY,this.repaint(),a.stopPropagation()}.bind(this),c=function(a){document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",c),document.removeEventListener("keyup",d),EditorUI.removeDragGhost(),a.stopPropagation()}.bind(this),d=function(a){16===a.keyCode&&(document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",c),document.removeEventListener("keyup",d),EditorUI.removeDragGhost(),a.stopPropagation())}.bind(this);return this._lastClientX=a.clientX,this._lastClientY=a.clientY,EditorUI.addDragGhost("cell"),document.addEventListener("mousemove",b),document.addEventListener("mouseup",c),document.addEventListener("keyup",d),void a.stopPropagation()}if(1===a.which){var e=function(a){var b=this._rectSelectStartX-this.view.left,c=this._rectSelectStartY-this.view.top,d=a.clientX-this._rectSelectStartX,e=a.clientY-this._rectSelectStartY;0>d&&(b+=d,d=-d),0>e&&(c+=e,e=-e),this.svgGizmos.updateSelection(b,c,d,e);var f=this.rectHitTest(new Fire.Rect(b,c,d,e));if(f.length>0){for(var g=[],h=0;h<f.length;++h)g.push(f[h].id);Fire.Selection.selectEntity(g,!0,!1)}else Fire.Selection.clearEntity();a.stopPropagation()}.bind(this),f=function(a){document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",f);var b=this._rectSelectStartX-this.view.left,c=this._rectSelectStartY-this.view.top,d=a.clientX-this._rectSelectStartX,g=a.clientY-this._rectSelectStartY;this.svgGizmos.fadeoutSelection(),EditorUI.removeDragGhost(),a.stopPropagation();var h=d*d+g*g;if(h>=4)Fire.Selection.confirm();else{var i=this.hitTest(b,c);i?Fire.Selection.selectEntity(i.id,!0):Fire.Selection.clearEntity()}}.bind(this);return this._rectSelectStartX=a.clientX,this._rectSelectStartY=a.clientY,EditorUI.addDragGhost("default"),document.addEventListener("mousemove",e),document.addEventListener("mouseup",f),void a.stopPropagation()}},mousewheelAction:function(a){var b=this.sceneCamera.scale;b=Math.pow(2,.002*a.wheelDelta)*b,b=Math.max(.01,Math.min(b,1e3)),this.sceneCamera.scale=b,this.repaint(),a.stopPropagation()},mouseleaveAction:function(a){Fire.Selection.hoverEntity(null),a.stopPropagation()},gizmoshoverAction:function(a){var b=a.detail.entity;Fire.Selection.hoverEntity(b?b.id:null),a.stopPropagation()},gizmosdirtyAction:function(a){this.repaint(),a.stopPropagation()},dragoverAction:function(a){var b=EditorUI.DragDrop.type(a.dataTransfer);return"asset"!==b?void EditorUI.DragDrop.allowDrop(a.dataTransfer,!1):(EditorUI.DragDrop.allowDrop(a.dataTransfer,!0),EditorUI.DragDrop.updateDropEffect(a.dataTransfer,"copy"),a.preventDefault(),void a.stopPropagation())},dropAction:function(a){var b=EditorUI.DragDrop.type(a.dataTransfer);if("asset"===b||"entity"===b){a.preventDefault(),a.stopPropagation(),Fire.Selection.cancel();var c=EditorUI.DragDrop.drop(a.dataTransfer),d=this.getBoundingClientRect(),e=function(b){b.createEntity&&b.createEntity(function(c){var e=new Fire.Vec2(a.clientX-d.left,a.clientY-d.top),f=this.renderContext.camera.screenToWorld(e);c.transform.worldPosition=f,Fire.Selection.selectEntity(c.id,!0,!0),Fire.AssetLibrary.cacheAsset(b),this.repaint()}.bind(this))}.bind(this);if(c.length>0&&"asset"===b)for(var f=0;f<c.length;++f)Fire.AssetLibrary.loadAsset(c[f],e)}}})}();</script></polymer-element></div><polymer-element name="fire-scene" constructor="FireScene" on-show="{{showAction}}" on-resize="{{resizeAction}}" on-layout-tools-changed="{{layoutToolsAction}}" assetpath=""><template><style>:host{display:flex;flex-direction:column;flex-wrap:nowrap;align-items:stretch;font-size:12px;white-space:nowrap;color:#ddd;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;cursor:default}.border{border:1px solid #171717;position:relative;background:#333}fire-ui-text-input{height:18px;width:180px;}fire-ui-text-input /deep/ .input-area{padding:0 2px}</style><fire-ui-toolbar justify-between=""><div class="left"></div><div class="right"><fire-ui-text-input placeholder="Search..."></fire-ui-text-input></div></fire-ui-toolbar><div class="border" flex-1=""><scene-view id="view" fit=""></scene-view></div></template><script>!function(){var a=require("fire-path"),b=require("fire-url"),c=require("remote");Polymer("fire-scene",{created:function(){this.icon=new Image,this.icon.src="fire://static/img/plugin-scene.png",this.ipc=new Fire.IpcListener,this._newsceneUrl=null},ready:function(){},attached:function(){this.ipc.on("selection:entity:selected",this.select.bind(this,!0)),this.ipc.on("selection:entity:unselected",this.select.bind(this,!1)),this.ipc.on("selection:entity:hover",this.hover.bind(this)),this.ipc.on("selection:entity:hoverout",this.hoverout.bind(this)),this.ipc.on("scene:dirty",this.delayRepaintScene.bind(this)),this.ipc.on("scene:save",this.saveCurrentScene.bind(this)),this.ipc.on("scene:launched",this.sceneLaunched.bind(this)),this.ipc.on("asset:saved",function(a,c){if(this._newsceneUrl===a){this._newsceneUrl=null;var d=b.basename(a);Fire.Engine._scene._uuid=c,Fire.Engine._scene.name=d,Fire.log(a+" saved")}}.bind(this)),this._repaintID=setInterval(this.repaintScene.bind(this),500)},detached:function(){clearInterval(this._repaintID),this.ipc.clear()},initRenderContext:function(){this.$.view.init()},resize:function(){var a=this.style.display;this.style.display="",this.$.view.resize(),this.style.display=a},select:function(a,b){a?this.$.view.select(b):this.$.view.unselect(b)},hover:function(a){a&&this.$.view.hover(a)},hoverout:function(a){a&&this.$.view.hoverout(a)},delayRepaintScene:function(){this._repainting||(this._repainting=!0,setTimeout(function(){this.repaintScene(),this._repainting=!1}.bind(this),100))},repaintScene:function(){this.$.view.repaint()},saveCurrentScene:function(){var b=Fire.Engine._scene,d=null,e=c.require("dialog");if(b._uuid)d=Fire.AssetDB.uuidToUrl(b._uuid);else{var f=Fire.AssetDB._fspath("assets://"),g=e.showSaveDialog(c.getCurrentWindow(),{title:"Save Scene",defaultPath:f,filters:[{name:"Scenes",extensions:["fire"]}]});g&&(a.contains(f,g)?d="assets://"+a.relative(f,g):(e.showMessageBox(c.getCurrentWindow(),{type:"warning",buttons:["OK"],title:"Warning",message:"Warning: please save the scene in the assets folder.",detail:"The scene needs to be saved inside the assets folder of your project."}),this.saveCurrentScene()))}d&&(this._newsceneUrl=d,Fire.sendToCore("asset-db:save",this._newsceneUrl,Fire.serialize(b)))},sceneLaunched:function(){this.$.view.initSceneCamera()},layoutToolsAction:function(a){this.$.view.rebuildGizmos(),a.stopPropagation()},showAction:function(a){this.resize()},resizeAction:function(a){this.resize()}})}();</script></polymer-element></body></html>