var Fire=Fire||{};process&&"renderer"!==process.type&&(Fire=global.Fire),function(a){!function(){a.arrayCmpFilter=function(a,b){var c,d,e,f;for(c=[],e=0;e<a.length;++e){d=a[e];var g=!0;for(f=0;f<c.length;++f){var h=c[f];if(d===h){g=!1;break}var i=b(h,d);if(i>0){g=!1;break}0>i&&(c.splice(f,1),--f)}g&&c.push(d)}return c},a.arrayResize=function(a,b){if(a.length>=b)return void(a.length=b);var c=a.length,d=a[a.length-1];a.length=b;for(var e=c;b>e;++e)a[e]=d.clone?d.clone():d},a.arrayFillUndefined=function(a,b){for(var c=0;c<a.length;++c)void 0===a[c]&&(a[c]=null!==b&&b.clone?b.clone():b)}}(),function(){if(a.isNode){var b=require("fs"),c=require("path"),d=function(a,e){for(var f=b.readdirSync(a),g=null,h="",i=0;i<f.length;i++){h=c.join(a,f[i]);try{g=b.statSync(h)}catch(j){continue}g.isFile()?e.push(h):g.isDirectory()&&d(h,e)}};a.readDirRecursively=function(c){var e=[];if(Array.isArray(c)){for(var f=0;f<c.length;f++)e=e.concat(a.readDirRecursively(c[f]));return e}var g=null;try{g=b.statSync(c)}catch(h){return[]}return g.isFile()?e.push(c):g.isDirectory()&&d(c,e),e}}else{var e=function(){throw new Error("This function can only be used in node-webkit or server")};a.readDirRecursively=e}if(a.isNodeWebkit&&a.isWeb){a.askSavePath=function(b,c,d,e){"function"==typeof d&&a.error("Fire.askSavePath: swap title and callback please");var f="SaveFileDialog",g=document.getElementById(f);g&&document.body.removeChild(g),g=document.createElement("input"),document.body.appendChild(g),g.id=f,g.style.display="none",g.type="file",g.nwsaveas=b;var h=localStorage[c];g.nwworkingdir=h||"",g.onchange=function(a){document.body.removeChild(g),g.onchange=null,localStorage[c]=this.value,e(this.value)},g.click()},a.getSavePath=function(){a.error("Fire.getSavePath is deprecated, use Fire.askSavePath plz")};var f=require("nw.gui");a.showItemInFolder=f.Shell.showItemInFolder}else if(a.isAtomShell)"undefined"==typeof localStorage&&(localStorage=a.userProfile||{}),a.askSavePath=function(b,c,d,e,f){var g=localStorage[c],h=null;g&&"string"==typeof g&&(g=a.Path.dirname(g),h=a.Path.join(g,b));var i;if(a.isWeb){var j=require("remote");i=j.require("dialog"),f||(f=j.getCurrentWindow())}else if(i=require("dialog"),!f){var k=require("browser-window");f=k.getFocusedWindow()}var l={title:d,defaultPath:h};i.showSaveDialog(f,l,function(a){a&&(localStorage[c]=a),e(a)})},a.askDirPath=function(b,c,d,e,f){var g=localStorage[c];g&&"string"==typeof g&&(b=g);var h;if(a.isWeb){var i=require("remote");h=i.require("dialog"),f||(f=i.getCurrentWindow())}else if(h=require("dialog"),!f){var j=require("browser-window");f=j.getFocusedWindow()}var k={title:d,defaultPath:b,properties:["openDirectory"]};h.showOpenDialog(f,k,function(a){a=a&&a[0],a&&(localStorage[c]=a),e(a)})},a.showItemInFolder=require("shell").showItemInFolder;else{var e=function(){throw new Error("This function can only be used in node-webkit or atom-shell")};a.askSavePath=e,a.askDirPath=e,a.showItemInFolder=e}}(),function(){a.UUID={AssetsRoot:"b4145302-f47b-49a5-ba5e-049f41ee4915"},a.SelfExcluded={FIRE_MSG_OPTIONS:!0,SelfExcluded:!0}}(),function(){function b(){this.listeningIpcs=[]}var c=require("ipc");b.prototype.on=function(a,b){c.on(a,b),this.listeningIpcs.push([a,b])},b.prototype.once=function(a,b){c.once(a,b),this.listeningIpcs.push([a,b])},b.prototype.clear=function(){for(var a=0;a<this.listeningIpcs.length;a++){var b=this.listeningIpcs[a];c.removeListener(b[0],b[1])}this.listeningIpcs.length=0},a.IpcListener=b}(),function(){var b=require("ipc");a.Selection=function(){var c="selection:entity:selected",d="selection:asset:selected",e="selection:entity:unselected",f="selection:asset:unselected",g="selection:entity:activated",h="selection:asset:activated",i="selection:entity:hover",j="selection:asset:hover",k="selection:entity:hoverout",l="selection:asset:hoverout",m=function(){function a(a){this.lastActive="",this.selection=[],this.lastHover="",this.msg_selected="selection:"+a+":selected",this.msg_unselected="selection:"+a+":unselected",this.msg_activate="selection:"+a+":activated",this.msg_deactivate="selection:"+a+":deactivated",this.msg_hover="selection:"+a+":hover",this.msg_hoverout="selection:"+a+":hoverout"}return a.prototype._activate=function(a){this.lastActive!==a&&(this.lastActive&&q._sendToAll(this.msg_deactivate,this.lastActive),this.lastActive=a,q._sendToAll(this.msg_activate,a))},a.prototype._unselectOthers=function(a){if(Array.isArray(a)){for(var b=[],c=this.selection.length-1;c>=0;c--){var d=this.selection[c];-1===a.indexOf(d)&&(this.selection.splice(c,1),b.push(d))}b.length>0&&q._sendToAll(this.msg_unselected,b)}else{var e=this.selection.indexOf(a);-1!==e?(this.selection.splice(e,1),this.selection.length>0&&q._sendToAll(this.msg_unselected,this.selection),this.selection=[a]):(this.selection.length>0&&q._sendToAll(this.msg_unselected,this.selection),this.selection.length=0)}},a.prototype.select=function(a,b){if(b&&this._unselectOthers(a),Array.isArray(a)){if(a.length>0){for(var c=[],d=0;d<a.length;d++)-1===this.selection.indexOf(a[d])&&(this.selection.push(a[d]),c.push(a[d]));c.length>0&&q._sendToAll(this.msg_selected,c),this._activate(a[a.length-1])}}else-1===this.selection.indexOf(a)&&(this.selection.push(a),q._sendToAll(this.msg_selected,[a])),this._activate(a)},a.prototype.unselect=function(a){var b=!1;if(Array.isArray(a)){if(a.length>0){for(var c=[],d=0;d<a.length;d++){var e=this.selection.indexOf(a[d]);-1!==e&&(this.selection.splice(e,1),c.push(a[d]),b=b||a[d]===this.lastActive)}c.length>0&&q._sendToAll(this.msg_unselected,c)}}else{var f=this.selection.indexOf(a);-1!==f&&(this.selection.splice(f,1),q._sendToAll(this.msg_unselected,[a]),b=a===this.lastActive)}b&&this._activate(this.selection.length>0?this.selection[this.selection.length-1]:"")},a.prototype.hover=function(a){a="string"==typeof a?a:"",this.lastHover!==a&&(this.lastHover&&q._sendToAll(this.msg_hoverout,this.lastHover),this.lastHover=a,a&&q._sendToAll(this.msg_hover,a))},Object.defineProperty(a.prototype,"contexts",{get:function(){var a=this.lastHover;if(a){var b=this.selection.indexOf(a);if(-1!==b){var c=this.selection.slice(0),d=c[0];return c[0]=a,c[b]=d,c}return[a]}return[]},enumerable:!0}),a.prototype.clear=function(){q._sendToAll(this.msg_unselected,this.selection),this.selection.length=0,this._activate("")},a}(),n=function(){function b(a){d.call(this,a),this.confirmed=!0,this._confirmedSnapShot=[]}function c(a){!this.confirmed&&a?this.confirm():this.confirmed&&!a&&(this._confirmedSnapShot=this.selection.slice(),this.confirmed=!1)}var d=m;return a.JS.extend(b,d),b.prototype._activate=function(a){this.confirmed&&d.prototype._activate.call(this,a)},b.prototype.select=function(a,b,e){c.call(this,e),d.prototype.select.call(this,a,b)},b.prototype.unselect=function(a,b){c.call(this,b),d.prototype.unselect.call(this,a)},b.prototype.confirm=function(){this.confirmed||(this._confirmedSnapShot.length=0,this.confirmed=!0,this._activate(this.selection[this.selection.length-1]))},b.prototype.cancel=function(){this.confirmed||(d.prototype.select.call(this,this._confirmedSnapShot,!0),this._confirmedSnapShot.length=0,this.confirmed=!0)},b}(),o=new n("entity"),p=new n("asset"),q={confirm:function(){o.confirm(),p.confirm()},cancel:function(){o.cancel(),p.cancel()},selectEntity:function(b,c,d){return"string"==typeof b||Array.isArray(b)?(c="undefined"!=typeof c?c:!0,d="undefined"!=typeof d?d:!0,o.select(b,c,d),void(this._lastGlobalActive!==o&&o.confirmed&&o.lastActive&&(this._lastGlobalActive=o,this._doSend("selection:activated","entity",o.lastActive)))):void a.error("entity selection argument must be id(string) or array")},unselectEntity:function(b,c){"string"==typeof b||Array.isArray(b)?(c="undefined"!=typeof c?c:!0,o.unselect(b,c)):a.error("entity selection argument must be id(string) or array")},selectAsset:function(b,c,d){return"string"==typeof b||Array.isArray(b)?(c="undefined"!=typeof c?c:!0,d="undefined"!=typeof d?d:!0,p.select(b,c,d),void(this._lastGlobalActive!==p&&p.confirmed&&p.lastActive&&(this._lastGlobalActive=p,this._doSend("selection:activated","asset",p.lastActive)))):void a.error("asset selection argument must be uuid(string) or array")},unselectAsset:function(b,c){"string"==typeof b||Array.isArray(b)?(c="undefined"!=typeof c?c:!0,p.unselect(b,c)):a.error("asset selection argument must be uuid(string) or array")},hoverEntity:function(a){o.hover(a)},hoverAsset:function(a){p.hover(a)},setContextEntity:function(a){this.hoverEntity(a)},setContextAsset:function(a){this.hoverAsset(a)},clearEntity:function(){o.clear(),o.confirm()},clearAsset:function(){p.clear(),p.confirm()},_lastGlobalActive:null,_doSend:function(b,c,d){a.sendToAll(b,c,d)},_sendToAll:function(a,b){switch(this._doSend(a,b),a){case"selection:asset:activated":this._doSend("selection:activated","asset",b),this._lastGlobalActive=p;break;case"selection:asset:deactivated":this._lastGlobalActive===p&&(this._doSend("selection:deactivated","asset",b),this._lastGlobalActive=null);break;case"selection:entity:activated":this._doSend("selection:activated","entity",b),this._lastGlobalActive=o;break;case"selection:entity:deactivated":this._lastGlobalActive===o&&(this._doSend("selection:deactivated","entity",b),this._lastGlobalActive=null)}}};return b.on("window-reloaded",function(a){a.isMainWindow&&(q.clearEntity(),q.clearAsset())}),b.on(c,function(a){a=a.filter(function(a){return-1===o.selection.indexOf(a)}),1===a.length?o.selection.push(a[0]):a.length>1&&(o.selection=o.selection.concat(a))}),b.on(d,function(a){a=a.filter(function(a){return-1===p.selection.indexOf(a)}),1===a.length?p.selection.push(a[0]):a.length>1&&(p.selection=p.selection.concat(a))}),b.on(e,function(a){o.selection=o.selection.filter(function(b){return-1===a.indexOf(b)})}),b.on(f,function(a){p.selection=p.selection.filter(function(b){return-1===a.indexOf(b)})}),b.on(g,function(a){o.lastActive=a}),b.on(h,function(a){p.lastActive=a}),b.on(i,function(a){o.lastHover=a}),b.on(j,function(a){p.lastHover=a}),b.on(k,function(a){o.lastHover=""}),b.on(l,function(a){p.lastHover=""}),Object.defineProperty(q,"hoveringEntityId",{get:function(){return o.lastHover},enumerable:!0}),Object.defineProperty(q,"hoveringAssetUuid",{get:function(){return p.lastHover},enumerable:!0}),Object.defineProperty(q,"contextEntities",{get:function(){return o.contexts},enumerable:!0}),Object.defineProperty(q,"contextAssets",{get:function(){return p.contexts},enumerable:!0}),Object.defineProperty(q,"activeEntityId",{get:function(){return o.lastActive},enumerable:!0}),Object.defineProperty(q,"activeAssetUuid",{get:function(){return p.lastActive},enumerable:!0}),Object.defineProperty(q,"entities",{get:function(){return o.selection.slice()},enumerable:!0}),Object.defineProperty(q,"assets",{get:function(){return p.selection.slice()},enumerable:!0}),q.filter=function(a,b,c){var d,e,f,g;if("name"===b)d=a.filter(c);else for(d=[],f=0;f<a.length;++f){e=a[f];var h=!0;for(g=0;g<d.length;++g){var i=d[g];if(e===i){h=!1;break}var j=c(i,e);if(j>0){h=!1;break}0>j&&(d.splice(g,1),--g)}h&&d.push(e)}return d},q}()}(),function(){function b(b,c,d,e){this["package"]=c,this.name=b,this.path=d,this._mainPath=e,this._ipc=new a.IpcListener}var c=require("path");b.prototype.openWindow=function(b,d){var e=this.config,f=e.windows&&e.windows[b];if(f)if(d=a.JS.mixin(d,f.options),f.url){var g=c.resolve(this.path,f.url);a.sendToCore("plugin:window:open",this.name,b,d,g)}else a.error('Failed to get "%s"\'s "url" from %s\'s package.json.',b,this.name);else a.error('Can not find the %s\'s "%s" window in the package.json.',this.name,b)},b.prototype.on=function(a,b){this._ipc.on(a,b)},b.prototype._destruct=function(){this._ipc.clear()},Object.defineProperty(b.prototype,"config",{get:function(){var a=this["package"].fireball;return console.assert(a),a}}),Object.defineProperty(b.prototype,"openedWindows",{get:function(){return a._PluginWindowMgr.getWindows(this.name)}}),a._PluginContext=b}(),function(){a._PluginLoaderBase=function(){function b(a){d.call(this),this.name=a,this.nameToPlugin={},this.launched=!1}var c=require("fire-path"),d=require("events").EventEmitter;return a.JS.extend(b,d),b.prototype.onAfterUnload=function(){},b.prototype._loadImpl=function(){},b.prototype._unloadImpl=function(){},b.prototype.loadAll=function(a){for(var b in this.nameToPlugin)this._loadImpl(this.nameToPlugin[b]);this.launched=!0,a&&a()},b.prototype.unloadAll=function(){for(var a in this.nameToPlugin)this.doUnload(this.nameToPlugin[a])},b.prototype.load=function(b,d){var e=b.name,f=b.fireball;if(f){var g=c.dirname(d),h="";f.main&&("string"==typeof f.main?h=c.resolve(g,f.main):a.warn('The "main" data in package.json must be a string'));var i=new a._PluginContext(e,b,g,h);this.nameToPlugin[e]=i,this.launched&&this._loadImpl(i)}},b.prototype.unload=function(b){console.log("unload",b);var c=this.nameToPlugin[b];c?(this.doUnload(c),delete this.nameToPlugin[b],this.onAfterUnload()):a.error("Plugin not loaded:",b)},b.prototype.doUnload=function(a){this._unloadImpl(a),a._destruct()},b.parseMeta=function(b,d){var e=b.config.asset;if(e){var f=c.join(b.path,"package.json");e=[].concat(e);for(var g in e){var h=e[g];h.pattern?h.meta?h.asset?d(h):a.error('Undefined "fireball/asset/asset" in %s',f):a.error('Undefined "fireball/asset/meta" in %s',f):a.error('Undefined "fireball/asset/pattern" in %s',f)}}},b}()}(),function(){var b=require("fire-fs");a.AssetMeta=function(){var c=require("events"),d=a.extend("Fire.AssetMeta",c,function(){this.dirty=!1});return d.prop("ver",0,a.Integer,a.HideInInspector),d.prop("uuid","",a.HideInInspector),d.prop("subRawData",void 0,a.ObjectType(Array),a.HideInInspector),d.prototype.setDirty=function(){this.dirty=!0},d.prototype.done=function(){this.emit("end")},d.prototype.error=function(a){this.emit("error",a)},d.prototype.exportToJson=function(a,c){b.writeFile(a.path,c,function(a){return a?void this.error(a):void this.done()}.bind(this))},d.prototype.startImport=function(a){return setImmediate(function(){var b=require("fire-path");if(!a.meta)return void this.error(new Error("file.meta is not assigned."));if(a.asset)a.asset.name=b.basenameNoExt(a.path),this["import"](a);else{if(!this.createAsset)return void this.done();this.createAsset(a.path,function(c,d){return c?void this.error(new Error("Failed to create asset for "+a.path)):(d&&(a.asset=d,a.asset.name=b.basenameNoExt(a.path)),void this["import"](a))}.bind(this))}}.bind(this)),this},d.prototype.startExport=function(a,b){return setImmediate(function(){return a.meta?void this["export"](a,b):void this.error(new Error("file.meta is not assigned."))}.bind(this)),this},d.prototype.assetType=a.Asset,d.prototype.createAsset=function(a,b){b()},d.prototype["import"]=function(a){this.done()},d.prototype["export"]=function(a,b){this.done()},d}()}(),function(){a.FolderMeta=function(){var b=a.extend("Fire.FolderMeta",a.AssetMeta);return b.prototype.createAsset=null,b.prototype["import"]=null,b.prototype["export"]=null,b.prototype.assetType=null,b}()}(),function(){a.JsonMeta=function(){var b=a.extend("Fire.JsonMeta",a.AssetMeta);return b.prop("binary",!1),b.prototype.assetType=a.JsonAsset,b.prototype.createAsset=function(b,c){var d=require("fire-fs");d.readFile(b,function(d,e){if(d)return void this.error(d);var f=new a.JsonAsset;try{f.json=JSON.parse(e)}catch(g){var h=require("util");return void this.error(new Error(h.format("Failed to parse %s:\n%s",b,g)))}c(null,f)}.bind(this))},b.prototype["import"]=function(b){var c=this,d=require("async");d.parallel([function(c){a.AssetDB.saveAssetToLibrary(b.meta.uuid,b.asset,c)},function(c){a.AssetDB.copyToLibrary(b.meta.uuid,".json",b.path,c)}],function(a){return a?void c.error(a):void c.done()})},b.prototype["export"]=function(a,b){this.exportToJson(a,b)},b}()}(),function(){a.PackageMeta=function(){var b=a.extend("Fire.PackageMeta",a.JsonMeta).prop("enable",!0);return b.prototype["import"]=function(b){a.PackageManager.unloadProjectPlugin(b.meta.uuid),b.meta.enable&&b.asset&&(console.assert(b.asset.json),a.PackageManager.loadProjectPlugin(b.meta.uuid,b.asset.json,b.path)),a.JsonMeta.prototype["import"].call(this,b)},b}()}(),function(){var b=require("fire-path");a.TextAssetMeta=function(){var c=a.extend("Fire.TextAssetMeta",a.AssetMeta);return c.prop("binary",!1),c.prototype.assetType=a.TextAsset,c.prototype.createAsset=function(c,d){Fs.readFile(c,function(e,f){if(e)return void d(e);var g=new a.TextAsset;g.text=f,g._setRawExtname(b.extname(c)),d(null,g)})},c.prototype["import"]=function(c){var d=this,e=require("async");e.parallel([function(b){a.AssetDB.saveAssetToLibrary(c.meta.uuid,c.asset,b)},function(d){a.AssetDB.copyToLibrary(c.meta.uuid,b.extname(c.path),c.path,d)}],function(a){return a?void d.error(a):void d.done()})},c}()}(),function(){a.CustomAssetMeta=function(){var b=a.extend("Fire.CustomAssetMeta",a.AssetMeta);return b.prop("binary",!1),b.prototype.assetType=a.CustomAsset,b.prototype.createAsset=function(a,b){b()},b.prototype["import"]=function(b){var c=this;a.AssetDB.saveJsonToLibrary(b.meta.uuid,b.path,function(a){return a?void c.error(a):void c.done()})},b.prototype["export"]=function(a,b){this.exportToJson(a,b)},b}()}(),function(){var b=require("fire-path"),c=function(c,d,e,f,g){c.contain(f,f,{r:255,g:255,b:255,a:0},"grid",function(c,f){if(c)return void(g&&g(c));var h=a.AssetDB.mkdirForUuid(d);if(h){var i=b.join(h,d+".thumb"+e);f.writeFile(i,function(a){g&&g(a)})}})};a.TextureType=function(a){return a[a.Texture=0]="Texture",a[a.Sprite=1]="Sprite",a[a.NormalMap=2]="Normal Map",a}({}),a.TextureMeta=function(){var d=a.extend("Fire.TextureMeta",a.AssetMeta);return d.prop("type",a.TextureType.Sprite,a.Enum(a.TextureType)),d.prop("wrapMode",a.Texture.WrapMode.Clamp,a.Enum(a.Texture.WrapMode)),d.prop("filterMode",a.Texture.FilterMode.Bilinear,a.Enum(a.Texture.FilterMode)),d.prototype.assetType=a.Texture,d.prototype.createAsset=function(c,d){var e=require("lwip");e.open(c,function(e,f){if(e)return void d(e);var g=new a.Texture;g.width=f.width(),g.height=f.height(),g._setRawExtname(b.extname(c)),g.lwipImage=f,d(null,g)})},d.prototype["import"]=function(d){var e=d.meta,f=d.asset,g=b.extname(d.path),h=b.basename(d.path,g);if(f.wrapMode=e.wrapMode,f.filterMode=e.filterMode,e.type===a.TextureType.Sprite){var i=!1;if(e.subRawData&&0!==e.subRawData.length||(e.subRawData=[],i=!0),i){var j=require("node-uuid"),k=new a.Sprite;k.name=h,k.texture=a.serialize.asAsset(e.uuid),k.width=f.width,k.height=f.height,k.rawWidth=f.width,k.rawHeight=f.height;var l=new a.SpriteMeta;l.uuid=j.v4(),l.rawTextureUuid=e.uuid,e.subRawData.push({asset:k,meta:l})}}else e.subRawData&&e.subRawData.length>0&&(e.subRawData=[]);var m=this,n="."+f._rawext,o=require("async");o.series([function(b){a.AssetDB.saveAssetToLibrary(e.uuid,f,b)},function(b){var c=a.AssetDB.uuidToLibraryPath(e.uuid);f.lwipImage.writeFile(c+n,b)},function(a){c(f.lwipImage,e.uuid,n,32,a)}],function(a,b){return a?void m.error(a):void m.done()})},d.prototype["export"]=null,d}()}(),function(){var b=require("fire-fs"),c=function(a,b,c,d){var e=d,f=b,g=c,h=0,i=0,j,k;for(k=0;c>k;k++)for(j=0;b>j;j++)if(a.getPixel(j,k).a>=e){g=k,k=c;break}for(k=c-1;k>=g;k--)for(j=0;b>j;j++)if(a.getPixel(j,k).a>=e){i=k-g+1,k=0;break}for(j=0;b>j;j++)for(k=g;g+i>k;k++)if(a.getPixel(j,k).a>=e){f=j,j=b;break}for(j=b-1;j>=f;j--)for(k=g;g+i>k;k++)if(a.getPixel(j,k).a>=e){h=j-f+1,j=0;break}return[f,g,h,i]};a.TrimType=function(a){return a[a.Auto=0]="Auto",a[a.Custom=1]="Custom",a}({}),a.SpriteMeta=function(){var d=a.extend("Fire.SpriteMeta",a.AssetMeta);return d.prop("atlasTag","default"),d.prop("trimType",a.TrimType.Auto,a.Enum(a.TrimType)),d.prop("trimThreshold",1),d.prop("rawTextureUuid","",a.HideInInspector),d.prototype.assetType=a.Sprite,d.prototype.createAsset=function(c,d){b.readFile(c,function(b,c){if(b)return void d(b);var e=a.deserialize(c);d(null,e)})},d.prototype["import"]=function(b){var d=this,e=b.meta,f=a.AssetDB.uuidToFspath(e.rawTextureUuid);if(!f)return void d.error(new Error("Can not find raw texture for "+b.path+", uuid not found: "+e.rawTextureUuid));var g=require("async"),h=require("lwip");g.waterfall([function(a){h.open(f,a)},function(d,f){var g=d.width(),h=d.height(),i=b.asset;if(i.rawWidth=g,i.rawHeight=h,a.AssetDB.isValidUuid(i.texture._uuid)||(i.texture=null),i.texture||(i.texture=a.serialize.asAsset(e.rawTextureUuid)),e.trimType===a.TrimType.Auto){var j=c(d,g,h,e.trimThreshold);i.trimX=j[0],i.trimY=j[1],i.width=j[2],i.height=j[3]}else i.trimX=Math.clamp(i.trimX,0,i.rawWidth),i.trimY=Math.clamp(i.trimY,0,i.rawHeight),i.width=Math.clamp(i.width,0,i.rawWidth-i.trimX),i.height=Math.clamp(i.height,0,i.rawHeight-i.trimY);i.texture._uuid===e.rawTextureUuid&&(i.x=i.trimX,i.y=i.trimY),f(null,i)},function(b,c){a.AssetDB.saveAssetToLibrary(e.uuid,b,c)}],function(a){return a?void d.error(a):void d.done()})},d.prototype["export"]=function(c,d){var e=a.deserialize(d),f=c.meta;f.rawTextureUuid=e.texture._uuid,b.writeFile(c.path,d,function(a){return a?void this.error(a):void this.done()}.bind(this))},d}()}(),function(){var b=require("fire-fs"),c=require("readline"),d=require("fire-url"),e=require("path"),f=function(a,d){var e=a.asset,f=a.meta;e.charInfos=[],e.kernings=[];var h=b.createReadStream(a.path,{encoding:"utf8"}),i=c.createInterface({input:h,output:process.stdout,terminal:!1});i.on("line",function(b){g(b,e,f,a.path)||d(new Error("Error: Failed to parse at line "+b))}).on("close",function(){d()})},g=function(c,d,f,g){var i={};i.chars={};var j=c.trimLeft(),k=j.split(" ");if("info"===k[0]){var l=h(k,"face");l&&(d.face=l.substring(1,l.length-1));var m=Math.floor(h(k,"size"));m&&(d.size=m)}else if("common"===k[0]){d.lineHeight=Math.floor(h(k,"lineHeight")),d.baseLine=Math.floor(h(k,"base"));var n=Math.floor(h(k,"pages"));if(1!=n)return a.error("Parse Error: only support one page"),!1}else if("page"===k[0]){var o=h(k,"file");if(f.texture)d.texture=f.texture;else{var p=o.substring(1,o.length-1),q=e.join(e.dirname(g),p);if(b.existsSync(q)){var r=a.AssetDB.fspathToUuid(q);d.texture=a.serialize.asAsset(r),f.texture=d.texture}}}else if("char"===k[0]){var s={id:Math.floor(h(k,"id")),y:Math.floor(h(k,"y")),x:Math.floor(h(k,"x")),width:Math.floor(h(k,"width")),height:Math.floor(h(k,"height")),xOffset:Math.floor(h(k,"xoffset")),yOffset:Math.floor(h(k,"yoffset")),xAdvance:Math.floor(h(k,"xadvance")),rotated:!1};d.charInfos.push(s)}else"kerning"===k[0]&&d.kernings.push({first:Math.floor(h(k,"first")),second:Math.floor(h(k,"second")),amount:Math.floor(h(k,"amount"))});return!0},h=function(a,b){for(var c=b.length+1,d=0;d<a.length;++d){var e=a[d];if(e.length>c&&e.substring(0,b.length)===b){var f=e.substring(c);if('"'===f[0]){if('"'===f[f.length-1])return f;for(var g=d+1;g<a.length;++g){var h=a[g];if(f=f+" "+h,'"'===f[f.length-1])return f}}return f}}return""};a.BitmapFontMeta=function(){var b=a.extend("Fire.BitmapFontMeta",a.AssetMeta);return b.prop("texture",null,a.ObjectType(a.Texture)),b.prototype.assetType=a.BitmapFont,b.prototype.createAsset=function(b,c){var d=new a.BitmapFont;c(null,d)},b.prototype["import"]=function(b){var c=this,d=require("async");d.waterfall([function(a){f(b,a)},function(c){a.AssetDB.saveAssetToLibrary(b.meta.uuid,b.asset,c)}],function(a){return a?void c.error(a):void c.done()})},b}()}(),function(){var b=require("fire-fs");a.AtlasMeta=function(){var c=[{name:"128",value:128},{name:"256",value:256},{name:"512",value:512},{name:"1024",value:1024},{name:"2048",value:2048},{name:"4096",value:4096}],d=a.extend("Fire.AtlasMeta",a.AssetMeta);return d.prop("autoSize",!0),d.prop("width",512,a.EnumList(c)),d.prop("height",512,a.EnumList(c)),d.prop("algorithm",a.Atlas.Algorithm.MaxRect,a.Enum(a.Atlas.Algorithm)),d.prop("sortBy",a.Atlas.SortBy.UseBest,a.Enum(a.Atlas.SortBy)),d.prop("sortOrder",a.Atlas.SortOrder.UseBest,a.Enum(a.Atlas.SortOrder)),d.prop("allowRotate",!0),d.prop("useContourBleed",!0,a.DisplayName("Contour Bleed"),a.Tooltip("reduce border artifacts")),d.prop("usePaddingBleed",!0,a.DisplayName("Padding Bleed"),a.Tooltip("extrude")),d.prop("customPadding",2,a.Integer),d.prop("buildColor",new a.Color(1,1,1,1),a.Nullable("customBuildColor",!1)),d.prototype.createAsset=function(c,d){var e=require("async");e.waterfall([function(a){b.readFile(c,a)},function(c,d){var f=a.deserialize(c);e.each(f.sprites,function(c,d){var e=f.sprites.indexOf(c),g=c._uuid,h=a.AssetDB.uuidToLibraryPath(g);b.readFile(h,function(b,c){if(b)return void d(b);var h=a.deserialize(c);h._uuid=g,f.sprites[e]=h,d()})},function(a){d(a,f)})}],function(a,b){d(a,b)})},d.prototype["import"]=function(b){var c=this,d=b.asset,e=b.meta,f=require("lwip"),g=require("async"),h=require(a.url("editor-core://meta"));g.waterfall([function(a){e.layout(d),a(null)},function(b){g.each(d.sprites,function(b,c){g.waterfall([function(c){var d=h.loadByUuid(b._uuid);if(!d)return void c(new Error("Failed to load sprite meta by uuid "+uuid));var e=a.AssetDB.uuidToFspath(d.rawTextureUuid);c(null,e,b)},function(a,b,c){f.open(a,function(a,d){c(a,d,b)})},function(a,b,c){a.crop(b.trimX,b.trimY,b.trimX+b.width-1,b.trimY+b.height-1,function(a,d){c(a,d,b)})},function(a,b,c){return b.rotated?void a.rotate(90,function(a,d){c(a,d,b)}):void c(null,a,b)},function(a,b,c){b.lwipImage=a,c(null)}],function(a){c(a)})},function(a){b(null)})},function(a){var b={r:0,g:0,b:0,a:0};d.customBuildColor&&(b={r:d.buildColor.r,g:d.buildColor.g,b:d.buildColor.b,a:d.buildColor.a/255*100}),f.create(d.width,d.height,b,function(b,c){a(b,c)})},function(b,c){g.eachSeries(d.sprites,function(c,d){try{b.paste(c.x,c.y,c.lwipImage,d)}catch(e){a.warn("Failed to paste sprite %s, message: %s",c.name,e.message),d()}},function(a){c(a,b)})},function(b,c){var f=null,g=null;if(e.subRawData)f=e.subRawData[0].asset,g=e.subRawData[0].meta;else{var h=require("node-uuid");e.subRawData=[],f=new a.Texture,g=new a.TextureMeta,g.uuid=h.v4(),e.subRawData.push({asset:f,meta:g})}f.name=d.name,f.width=b.width(),f.height=b.height(),f._setRawExtname(".png"),f.lwipImage=b,g.type=a.TextureType.Texture,g.wrapMode=a.Texture.WrapMode.Clamp,g.filterMode=a.Texture.FilterMode.Bilinear,c(null,g.uuid)},function(b,c){g.each(d.sprites,function(c,d){c.texture=a.serialize.asAsset(b);var e=a.AssetDB.uuidToUrl(c._uuid);a.AssetDB.saveAsset(e,a.serialize(c),null).on("end",function(b,c){for(var e=0;e<c.length;++e){var f=c[e];a.sendToAll("asset:saved",f.url,f.uuid)}d()})},function(a){c(a)})},function(b){a.AssetDB.saveAssetToLibrary(e.uuid,d,b)}],function(a){return a?void c.error(a):void c.done()})},d.prototype["export"]=function(c,d){var e=a.deserialize(d);b.writeFile(c.path,d,function(a){return a?void this.error(a):void this.done()}.bind(this))},d.prototype.layout=function(a){a.width=this.width,a.height=this.height,a.layout({algorithm:this.algorithm,sortBy:this.sortBy,sortOrder:this.sortOrder,allowRotate:this.allowRotate,autoSize:this.autoSize,padding:this.customPadding})},d}()}()}(Fire),"undefined"!=typeof module&&module?module.exports=Fire:"function"==typeof define&&define&&define.amd&&define([],function(){return Fire});