var Path=require("path"),os=require("os"),fs=require("fire-fs"),del=require("del"),format=require("util").format,Gulp=require("gulp").Gulp,gutil=require("gulp-util"),es=require("event-stream"),Ipc=require("ipc"),compileGulp=require("./gulp-compile"),BUILD_="build-platform_";exports.startWithArgs=function(a,b){function c(b,c){return d.src(b).pipe(es.through(function f(b){if(".html"===Path.extname(b.path)){console.log("generating html from "+b.path);var c={file:b,project:a.projectName||Path.basename(e),lib:Path.basename(l.runtime_lib)};b.contents=new Buffer(gutil.template(b.contents,c))}this.emit("data",b)})).pipe(d.dest(g)).on("end",c)}var d=new Gulp,e=a.project,f=a.platform,g=a.dest,h=a.debug;console.log("Building "+e),console.log("Destination "+g);var i,j;"cocos2d-js"===a.projectType?(i=h?"src/runtime/cocos/cocos2d.dev.js":"src/runtime/cocos/cocos2d.min.js",j=h?"tools/build/engine/cocos/fireball.dev.js":"tools/build/engine/cocos/fireball.js"):(i=h?"ext/pixi/bin/pixi.dev.js":"ext/pixi/bin/pixi.js",j=h?"tools/build/engine/basic/fireball.dev.js":"tools/build/engine/basic/fireball.js");var k=Path.resolve(Editor.cwd,"tools/build/platforms/"),l={template_web_desktop:Path.join(k,h?"web-desktop/template-dev/**/*":"web-desktop/template/**/*"),template_web_mobile:Path.join(k,h?"web-mobile/template-dev/**/*":"web-mobile/template/**/*"),script:h?"project.dev.js":"project.js",runtime_lib:Path.resolve(Editor.cwd,i),fireball:Path.resolve(Editor.cwd,j),res:Path.join(g,"resource"),settings:Path.join(g,"settings.json")};l.deps=[l.runtime_lib,l.fireball],d.task("copy-deps",function(){return d.src(l.deps).pipe(d.dest(g))}),d.task("compile",function(a){var b={project:e,platform:f,dest:Path.join(g,l.script),debug:h};compileGulp.startWithArgs(b,function(b){b?d.isRunning?d.stop(b):Fire.error(b):a()})}),d.task("build-assets",["compile"],function(a){Ipc.once("build-assets:reply",function(){a()}),Editor.sendToMainWindow("build-assets",e,l.res,h)}),d.task("build-settings",["copy-deps"],function(b){var c={scenes:{},launchScene:"",resBundle:a.resBundle},d=a.scenes;c.launchScene=d[0].name;for(var e=0;e<d.length;e++){var f=d[e];c.scenes[f.name]=f.uuid}var g=JSON.stringify(c,null,h?4:0);fs.writeFile(l.settings,g,b)}),d.task(BUILD_+"web-desktop",["compile","copy-deps","build-assets","build-settings"],function(a){c(l.template_web_desktop,a)}),d.task(BUILD_+"web-mobile",["compile","copy-deps","build-assets","build-settings"],function(a){c(l.template_web_mobile,a)});var m=Path.join(os.tmpdir(),"fireball-game-builds");d.task("clean-built-target",function(a){fs.existsSync(m)?del(m+"/**/*",{force:!0},a):a()}),d.task("copy-built-target",["clean-built-target"],function(){return console.log("built files copying to: "+m),d.src(g+"/**/*").pipe(d.dest(m))});var n=BUILD_+f;if(n in d.tasks)d.start(n,function(a){a?b(a):d.start("copy-built-target",b)});else{var o=[];for(var p in d.tasks)0===p.indexOf(BUILD_)&&o.push(p.substring(BUILD_.length));b(format("Not support %s platform, available platform currently: %s",f,o))}};