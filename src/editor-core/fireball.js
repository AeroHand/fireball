var Fs=require("fire-fs"),Path=require("fire-path"),Ipc=require("ipc"),FireMenu=require("./fire-menu"),MainMenu=require("./main-menu"),AssetDB=require("./asset-db"),FireWindow=require("./fire-window"),PackageManager=require("./packages/package-manager"),PluginWindowMgr=require("./packages/plugin-window-mgr"),PackageReloader=require("./packages/reloader"),Compiler=require("./compiler"),_projectName="",_projectPath="",_projectInited=!1;Ipc.on("assets:deleted",function(a){var b=a.map(function(a){return a.uuid});Fire.Selection.unselectAsset(b),-1!==b.indexOf(Fire.Selection.hoveringAssetUuid)&&Fire.Selection.hoverAsset("")}),Ipc.on("window:open",function(a,b,c){var d=new FireWindow(a,c);d.nativeWin.setMenuBarVisibility(!1),d.load(b,c.query),d.show()});var registerGlobal=function(){global["AssetDB@"+Fire.App.id]=AssetDB.exportToGlobal()},checkProject=function(a){Fs.existsSync(a)&&Fs.statSync(a).isDirectory()||Fs.makeTreeSync(a);var b=Path.join(a,"assets");Fs.existsSync(b)&&Fs.statSync(b).isDirectory()||Fs.mkdirSync(b);var c=Path.join(a,"settings");Fs.existsSync(c)&&Fs.statSync(c).isDirectory()||Fs.mkdirSync(c);var d=Path.join(a,"library");Fs.existsSync(d)&&Fs.statSync(d).isDirectory()||Fs.mkdirSync(d);var e=Path.join(a,"local");Fs.existsSync(e)&&Fs.statSync(e).isDirectory()||Fs.mkdirSync(e)},openProject=function(a,b){Fire.AssetDB.init(a),Fire.AssetDB.refreshAll(b),_projectInited=!0},Fireball={open:function(a){Fire.info("Launch project: "+a.project),registerGlobal(),_projectName=Path.basenameNoExt(a.project),_projectPath=Path.resolve(a.project),Fire.AssetDB=new AssetDB,Fire.FireMenu=FireMenu,Fire.PackageManager=PackageManager,Fire.log("Opening project: "+_projectName),checkProject(_projectPath),global.FIRE_PROJECT_PATH=_projectPath,MainMenu.init();var b=new FireWindow("main",{title:"Fireball",width:1280,height:720,"min-width":800,"min-height":600,show:!1,resizable:!0});Ipc.on("project:init",function(){_projectInited?Fire.sendToPages("project:ready"):PackageReloader.loadExternalPlugins(function(){openProject(_projectPath,function(){Fire.sendToAll("project:ready"),a.showDevtools&&b.openDevTools()})})}),Fire.App.mainWindow=b,PluginWindowMgr.register("asset-db",b),b.load("fire://static/fireball.html"),b.show()}};module.exports=Fireball;