function FireWindow(a,b){this._loaded=!1,this.name=a,this.closeWhenBlur=b["close-when-blur"]||!1,this.isPanelWindow=b["panel-window"]||!1,this.nativeWin=new BrowserWindow(b),this.closeWhenBlur&&this.nativeWin.setAlwaysOnTop(!0),this.handleEvents(),FireWindow.addWindow(this)}var EventEmitter=require("events"),BrowserWindow=require("browser-window"),Screen=require("screen"),Url=require("fire-url"),Ipc=require("ipc");Fire.JS.extend(FireWindow,EventEmitter),Object.defineProperty(FireWindow.prototype,"isMainWindow",{get:function(){return Fire.mainWindow===this}}),Object.defineProperty(FireWindow.prototype,"isFocused",{get:function(){return this.nativeWin.isFocused()}}),Object.defineProperty(FireWindow.prototype,"isMinimized",{get:function(){return this.nativeWin.isMinimized()}}),Object.defineProperty(FireWindow.prototype,"isLoaded",{get:function(){return this._loaded}}),FireWindow.prototype.handleEvents=function(){this.nativeWin.on("blur",function(){Fire.AssetDB&&Fire.AssetDB.ready&&(setImmediate(function(){BrowserWindow.getFocusedWindow()||Fire.AssetDB.watchON()}.bind(this)),this.closeWhenBlur&&this.nativeWin.close())}.bind(this)),this.nativeWin.on("focus",function(a){Fire.AssetDB&&Fire.AssetDB.ready&&Fire.AssetDB.watchOFF()}.bind(this)),this.nativeWin.on("closed",function(){Fire.PanelMng._onWindowClosed(this),this.isMainWindow?(this.isPanelWindow&&FireWindow.saveLayout(),FireWindow.removeWindow(this),Fire.mainWindow=null,Fire.App.quit()):FireWindow.removeWindow(this)}.bind(this)),this.nativeWin.webContents.on("did-finish-load",function(){this._loaded=!0,this.nativeWin.isFocused()&&Fire.AssetDB&&Fire.AssetDB.ready&&Fire.AssetDB.watchOFF(),Fire.sendToCore("window-reloaded",this)}.bind(this))},FireWindow.prototype.sendToPage=function(){var a=this.nativeWin.webContents;return a?void a.send.apply(a,arguments):void console.error('Failed to send "%s" to %s because web contents not yet loaded',arguments[0],this.name)},FireWindow.prototype.load=function(a,b){this._loaded=!1;var c=Url.format({protocol:"file",pathname:Fire.url(a),slashes:!0,query:Fire.JS.mixin({fireID:Fire.App.id},b)});this.nativeWin.loadUrl(c)},FireWindow.prototype.show=function(){this.nativeWin.show()},FireWindow.prototype.close=function(){this._loaded=!1,this.nativeWin.close()},FireWindow.prototype.focus=function(){this.nativeWin.focus()},FireWindow.prototype.minimize=function(){this.nativeWin.minimize()},FireWindow.prototype.restore=function(){this.nativeWin.restore()},FireWindow.prototype.openDevTools=function(){this.nativeWin.openDevTools()},FireWindow.prototype.adjust=function(a,b,c,d){var e=!1;"number"!=typeof a&&(e=!0,a=0),"number"!=typeof b&&(e=!0,b=0),"number"!=typeof c&&(e=!0,c=800),"number"!=typeof d&&(e=!0,d=600);var f=Screen.getDisplayMatching({x:a,y:b,width:c,height:d});this.nativeWin.setSize(c,d),this.nativeWin.setPosition(f.workArea.x,f.workArea.y),e?this.nativeWin.center():this.nativeWin.setPosition(a,b)};var _windows=[],_windowLayouts={};Object.defineProperty(FireWindow,"windows",{get:function(){return _windows.slice()}}),FireWindow.find=function(a){var b,c;if("string"==typeof a){for(b=0;b<_windows.length;++b)if(c=_windows[b],c.name===a)return c;return null}if(a instanceof BrowserWindow){for(b=0;b<_windows.length;++b)if(c=_windows[b],c.nativeWin===a)return c;return null}return null},FireWindow.addWindow=function(a){_windows.push(a)},FireWindow.removeWindow=function(a){var b=_windows.indexOf(a);return-1===b?void Fire.warn("Can not find window "+a.name):void _windows.splice(b,1)},FireWindow.saveLayout=function(){if(Fire.mainWindow){var a=Fire.loadProfile("layout","local");a.windows={};for(var b=0;b<_windows.length;++b){var c=_windows[b];a.windows[c.name]=_windowLayouts[c.name]}a.save()}},Ipc.on("window:open",function(a,b,c){var d=new Fire.Window(a,c);d.nativeWin.setMenuBarVisibility(!1),d.load(b,c.argv),d.show()}),Ipc.on("window:save-layout",function(a,b){var c=BrowserWindow.fromWebContents(a.sender),d=Fire.Window.find(c);if(!d)return void Fire.warn("Failed to save layout, can not find the window.");var e=c.getSize(),f=c.getPosition(),g={x:f[0],y:f[1],width:e[0],height:e[1],layout:b},h=Fire.loadProfile("layout","local");h.panels=h.panels||{};var i=[];"standalone"===b.type?i.push({name:b.panel,width:b.width,height:b.height}):_getPanels(b.docks,i);for(var j=0;j<i.length;++j){var k=i[j];h.panels[k.name]={window:d.name,x:f[0],y:f[1],width:k.width,height:k.height}}h.save(),_windowLayouts[d.name]=g,FireWindow.saveLayout()});var _getPanels=function(a,b){for(var c=0;c<a.length;++c){var d=a[c];if("dock"===d.type)_getPanels(d.docks,b);else if("panel"===d.type)for(var e=0;e<d.panels.length;++e){var f=d.panels[e];b.push({name:f,width:d.width,height:d.height})}}};module.exports=FireWindow;