var Path=require("path"),Fs=require("fs"),Uuid=require("node-uuid"),BuiltinMetas=[["package.json",Fire.PackageMeta],[".png .jpg",Fire.TextureMeta],[".sprite",Fire.SpriteMeta],[".atlas",Fire.AtlasMeta],[".json",Fire.JsonMeta],[".asset .fire",Fire.CustomAssetMeta],[".fnt .bmf .bmfont",Fire.BitmapFontMeta],[".txt .plist",Fire.TextAssetMeta]],Meta={_basenameToCtor:{},_extnameToCtor:{},_metaTypeToExtnames:new Map,create:function(a,b){var c=this.getType(a,""===Path.extname(a));if(!c)throw new Error("Can not get metaType from "+a);b||(b=Uuid.v4());var d=new c;return d.uuid=b,d.setDirty(),d},init:function(){for(var a in BuiltinMetas){var b=BuiltinMetas[a],c=b[0],d=b[1];this.register(c,d)}},load:function(a){var b=null,c=a+".meta";if(Fs.existsSync(c)){var d=Fs.readFileSync(c);try{b=Fire.deserialize(d)}catch(e){Fire.warn(e),b=null}var f=this.getType(a,""===Path.extname(a));b&&b.constructor!==f&&(Fire.warn("Meta type not the same, loaded: %s, expect: %s. Automatically convert meta to expect type.",Fire.JS.getClassName(b.constructor),Fire.JS.getClassName(f)),b=null)}return b},loadByUuid:function(a){var b=Fire.AssetDB.uuidToUrl(a),c=Fire.AssetDB.fspath(b);if(!Fire.AssetDB.isSubAsset(b))return Meta.load(c);var d=Path.dirname(c)+".meta",e=Meta.load(Path.dirname(c));if(e&&e.subRawData&&e.subRawData.length>0)for(var f=0;f<e.subRawData.length;++f){var g=e.subRawData[f];if(g.meta.uuid===a)return g.meta}return null},loadOrCreateNew:function(a){var b=this.load(a);return b||(b=this.create(a)),b},save:function(a,b,c){b.subRawData&&0===b.subRawData.length&&(b.subRawData=void 0);var d=Fire.serialize(b,{nicify:!0});Fs.writeFile(a+".meta",d,function(a){b.dirty=!1,c(a)})},saveSync:function(a,b){b.subRawData&&0===b.subRawData.length&&(b.subRawData=void 0);var c=Fire.serialize(b,{nicify:!0});Fs.writeFileSync(a+".meta",c),b.dirty=!1},getType:function(a,b,c){if(b)return Fire.FolderMeta;var d=Path.basename(a),e=this._basenameToCtor[d];if(e)return e;var f=Path.extname(d).toLowerCase();return(e=this._extnameToCtor[f])?e:(c="undefined"!=typeof c?c:!0,c&&Fire.AssetMeta)},getDefautExtname:function(a){var b;b="function"==typeof a?a:a.constructor;var c=this._metaTypeToExtnames.get(b);return c?c[0]:(Fire.error("Unregistered file extname for "+Fire.JS.getClassName(b)),"")},getExtnames:function(a){var b=[];return this._metaTypeToExtnames.forEach(function(c,d){d.prototype.assetType===a&&(b=b.concat(c))}),0===b.length&&Fire.error("Unregistered file extnames for "+Fire.JS.getClassName(a)),b},register:function(a,b,c){if(!Fire.isChildClassOf(b,Fire.AssetMeta))return void Fire.warn("Failed to register pattern %s, The metaType is not extended from Fire.AssetMeta",a);Array.isArray(a)||(a=a.split(" "));for(var d=0;d<a.length;++d){var e=a[d],f=this.getType(e,!1,!1);f&&Fire.warn("The pattern %s have been registered for %s. For now override by %s.",e,Fire.JS.getClassName(f),Fire.JS.getClassName(b)),"."===e[0]&&""===Path.extname(e)?this._extnameToCtor[e]=b:Path.basename(e)===e?this._basenameToCtor[e]=b:Fire.error("Not yet supported pattern %s for %s",e,Fire.JS.getClassName(b))}var g=this._metaTypeToExtnames.get(b);g?Fire.error('The meta "%s" has already been registered for "%s"',Fire.JS.getClassName(b),g):this._metaTypeToExtnames.set(b,a)},reset:function(){this._basenameToCtor={},this._extnameToCtor={},this._metaTypeToExtnames.clear(),this.init()}};module.exports=Meta;