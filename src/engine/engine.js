(function(){function _getStyle(a){var b=emptyFont;a.bitmapFont&&a.bitmapFont.face&&(b={face:a.bitmapFont.face,size:a.bitmapFont.size,align:BitmapText.TextAlign[a.align]});var c={font:b.size+" "+b.face,align:b.align};return c}function _setStyle(a){var b=_getStyle(a);a._renderObj&&a._renderObj.setStyle(b),a._renderObjInScene&&a._renderObjInScene.setStyle(b)}function _getNewMatrix23(a,b){var c=new Fire.Matrix23;return c.a=a.scale.x,c.b=0,c.c=0,c.d=a.scale.y,c.tx=a.position.x,c.ty=-a.position.y,c.prepend(b),c.b=-c.b,c.c=-c.c,c.ty=Fire.Engine._curRenderContext.renderer.height-c.ty,c}function _registerFont(a){var b={};if(a&&a.face){b.font=a.face,b.size=a.size,b.lineHeight=a.lineHeight,b.chars={};for(var c=0,d=a.charInfos,e=d.length;e>c;c++){var f=d[c],g=f.id,h=new PIXI.Rectangle(f.x,f.y,f.width,f.height),i=null;if(a&&a.texture){var j=new PIXI.BaseTexture(a.texture.image);i=new PIXI.Texture(j,h)}b.chars[g]={xOffset:f.xOffset,yOffset:f.yOffset,xAdvance:f.xAdvance,kerning:{},texture:PIXI.TextureCache[g]=i}}var k=a.kernings;for(c=0;c<k.length;c++){var l=k[c],m=l.first,n=l.second,o=l.amount;b.chars[n].kerning[m]=o}}else b.font="None",b.size=1,b.lineHeight=1,b.chars={};PIXI.BitmapText.fonts[b.font]=b}function ImageLoader(a,b,c){FireUrl&&(a=FireUrl.addRandomQuery(a));var d=document.createElement("img");d.crossOrigin="Anonymous";var e=function(){b&&b(this),d.removeEventListener("load",e),d.removeEventListener("error",f),d.removeEventListener("progress",c)},f=function(a,g,h){if(b){var i="Failed to load image: "+a+" Url: "+h;b(null,i)}d.removeEventListener("load",e),d.removeEventListener("error",f),d.removeEventListener("progress",c)};return d.addEventListener("load",e),d.addEventListener("error",f),c&&d.addEventListener("progress",c),d.src=a,d}function _LoadFromXHR(a,b,c,d){var e=new XMLHttpRequest,f=-1;e.onreadystatechange=function(){e.readyState===e.DONE?(b&&(200===e.status||0===e.status?b(e):b(null,'LoadFromXHR: Could not load "'+a+'", status: '+e.status)),e.onreadystatechange=null,g&&e.removeEventListener("progress",g)):(!c||e.readyState!==e.LOADING||"onprogress"in e||(-1===f&&(f=e.getResponseHeader("Content-Length")),c(e.responseText.length,f)),c&&e.readyState===e.HEADERS_RECEIVED&&(f=e.getResponseHeader("Content-Length")))},e.open("GET",a,!0),d&&(e.responseType=d);var g;c&&"onprogress"in e&&(g=function(a){a.lengthComputable&&c(a.loaded,a.total)},e.addEventListener("progress",onprogress)),e.send()}function TextLoader(a,b,c){var d=b&&function(c,d){c&&c.responseText?b(c.responseText):b(null,'TextLoader: "'+a+'" seems to be unreachable or the file is empty. InnerMessage: '+d)};_LoadFromXHR(a,d,c)}function JsonLoader(a,b,c){var d=b&&function(c,d){if(c&&c.responseText){var e;try{e=JSON.parse(c.responseText)}catch(f){return void b(null,f)}b(e)}else b(null,'JsonLoader: "'+a+'" seems to be unreachable or the file is empty. InnerMessage: '+d)};_LoadFromXHR(a,d,c)}var root=this,Fire=root.Fire||{},__TESTONLY__={};Fire.__TESTONLY__=__TESTONLY__;var FObject=Fire.FObject,HashObject=Fire.HashObject,Asset=Fire.Asset,Vec2=Fire.Vec2,Matrix23=Fire.Matrix23,Rect=Fire.Rect,Color=Fire.Color,Texture=Fire.Texture,Sprite=Fire.Sprite,Atlas=Fire.Atlas,AssetsWatcher={initComponent:function(){},start:function(){},stop:function(){}};Fire._AssetsWatcher=AssetsWatcher;var Destroying=Fire._ObjectFlags.Destroying,Hide=Fire._ObjectFlags.Hide,HideInGame=Fire._ObjectFlags.HideInGame,HideInEditor=Fire._ObjectFlags.HideInEditor,IsOnEnableCalled=Fire._ObjectFlags.IsOnEnableCalled,IsOnLoadCalled=Fire._ObjectFlags.IsOnLoadCalled,IsOnStartCalled=Fire._ObjectFlags.IsOnStartCalled,editorCallback={onEnginePlayed:null,onEngineStopped:null,onEnginePaused:null,onEntityCreated:null,onEntityRemoved:null,onEntityParentChanged:null,onEntityIndexChanged:null,onEntityRenamed:null,onSceneLaunched:null,onComponentEnabled:null,onComponentDisabled:null},Time=function(){var a={};a.time=0,a.realTime=0,a.deltaTime=0,a.frameCount=0,a.maxDeltaTime=.3333333;var b=0,c=0;return a._update=function(d,e){if(!e){var f=d-b;f=Math.min(a.maxDeltaTime,f),b=d,++a.frameCount,a.deltaTime=f,a.time+=f}a.realTime=d-c},a._restart=function(d){a.time=0,a.realTime=0,a.deltaTime=0,a.frameCount=0,b=d,c=d},a}();Fire.Time=Time;var Event=function(){function a(a,b){"undefined"==typeof b&&(b=!1),this.type=a,this.target=null,this.currentTarget=null,this.eventPhase=0,this.bubbles=b,this._defaultPrevented=!1,this._propagationStopped=!1,this._propagationImmediateStopped=!1}return a.NONE=0,a.CAPTURING_PHASE=1,a.AT_TARGET=2,a.BUBBLING_PHASE=3,a.prototype.stop=function(a){this._propagationStopped=!0,a&&(this._propagationImmediateStopped=!0)},a.prototype.preventDefault=function(){this._defaultPrevented=!0},a.prototype._reset=function(){this.target=null,this.currentTarget=null,this.eventPhase=0,this._defaultPrevented=!1,this._propagationStopped=!1,this._propagationImmediateStopped=!1},a}();Fire.Event=Event;var EventListeners=function(){function a(){Fire._CallbacksHandler.call(this)}return Fire.extend(a,Fire._CallbacksHandler),a.prototype.invoke=function(a){var b=this._callbackTable[a.type];if(b&&b.length>0){if(1===b.length)return void b[0](a);for(var c=b.length-1,d=b[c],e=0;c>=e;++e){var f=b[e];if(f(a),a._propagationImmediateStopped||e===c)break;if(b[c]!==d){if(b[c-1]!==d)return void Fire.error("Call event.stop(true) when you remove more than one callbacks in a event callback.");b[e]!==f&&--e,--c}}}},a}(),EventTarget=function(){function a(){HashObject.call(this),this._capturingListeners=null,this._bubblingListeners=null}Fire.extend(a,HashObject),a.prototype.on=function(a,b,c){return c="undefined"!=typeof c?c:!1,b?void(c?(this._capturingListeners=this._capturingListeners||new EventListeners,this._capturingListeners.has(a,b)||this._capturingListeners.add(a,b)):(this._bubblingListeners=this._bubblingListeners||new EventListeners,this._bubblingListeners.has(a,b)||this._bubblingListeners.add(a,b))):void Fire.error("Callback of event must be non-nil")},a.prototype.off=function(a,b,c){if(c="undefined"!=typeof c?c:!1,b){var d=c?this._capturingListeners:this._bubblingListeners;d&&d.remove(a,b)}},a.prototype.once=function(a,b,c){var d=this,e=function(f){d.off(a,e,c),b(f)};this.on(a,e,c)};var b=new Array(16);return b.length=0,a.prototype._doDispatchEvent=function(a){a.target=this,this._getCapturingTargets(a.type,b),a.eventPhase=1;var c,d;for(d=b.length-1;d>=0;--d)if(c=b[d],c.isValid&&c._capturingListeners&&(a.currentTarget=c,c._capturingListeners.invoke(a),a._propagationStopped))return;if(b.length=0,(!this.isValid||(this._doSendEvent(a),!a._propagationStopped))&&a.bubbles)for(this._getBubblingTargets(a.type,b),a.eventPhase=3,d=0;d<b.length;++d)if(c=b[d],c.isValid&&c._bubblingListeners&&(a.currentTarget=c,c._bubblingListeners.invoke(a),a._propagationStopped))return},a.prototype.dispatchEvent=function(a){this._doDispatchEvent(a),b.length=0;var c=!a._defaultPrevented;return a._reset(),c},a.prototype._doSendEvent=function(a){a.eventPhase=2,a.currentTarget=this,this._capturingListeners&&(this._capturingListeners.invoke(a),a._propagationStopped)||this._bubblingListeners&&this._bubblingListeners.invoke(a)},a.prototype._getCapturingTargets=function(a,b){},a.prototype._getBubblingTargets=function(a,b){},a}();Fire.EventTarget=EventTarget;var Ticker=function(){var a={},b=60;return window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,a.requestAnimationFrame=60===b&&window.requestAnimationFrame?function(a){return window.requestAnimationFrame(a)}:function(a){return window.setTimeout(a,1e3/b)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame,a.cancelAnimationFrame=window.cancelAnimationFrame?function(a){window.cancelAnimationFrame(a)}:function(a){window.clearTimeout(a)},a.now=window.performance&&window.performance.now?function(){return window.performance.now()/1e3}:function(){return Date.now()/1e3},a}();__TESTONLY__.Ticker=Ticker,PIXI.dontSayHello=!0;var EMPTY_METHOD=function(){};PIXI.DisplayObject.prototype.updateTransform=EMPTY_METHOD,PIXI.DisplayObject.prototype.displayObjectUpdateTransform=EMPTY_METHOD,PIXI.DisplayObjectContainer.prototype.displayObjectContainerUpdateTransform=EMPTY_METHOD;var RenderContext=function(){function a(a,b,c,d){a=a||800,b=b||600,d=d||!1;var e=!1;this.stage=new PIXI.Stage(0),this.root=this.stage,this.renderer=PIXI.autoDetectRenderer(a,b,{view:c,transparent:d,antialias:e}),this.sceneView=null,this._camera=null}function b(a){if(a&&a.texture&&a.texture.image){var b=new PIXI.BaseTexture(a.texture.image),c=new PIXI.Rectangle(a.x,a.y,Math.min(b.width-a.x,a.width),Math.min(b.height-a.y,a.height));return new PIXI.Texture(b,c)}return null}var c=new PIXI.Texture(new PIXI.BaseTexture);a.initRenderer=function(a){a._renderObj=null,a._renderObjInScene=null,a._tempMatrix=new Fire.Matrix23},Object.defineProperty(a.prototype,"canvas",{get:function(){return this.renderer.view}}),Object.defineProperty(a.prototype,"size",{get:function(){return new Vec2(this.renderer.width,this.renderer.height)},set:function(a){this.renderer.resize(a.x,a.y)}}),Object.defineProperty(a.prototype,"background",{set:function(a){this.stage.setBackgroundColor(a.toRGBValue())}}),Object.defineProperty(a.prototype,"camera",{get:function(){return this._camera},set:function(a){this._camera=a,Fire.isValid(a)&&(a.renderContext=this)}}),a.prototype.render=function(){this.renderer.render(this.stage)},a.prototype.onRootEntityCreated=function(a){a._pixiObj=new PIXI.DisplayObjectContainer,Engine._canModifyCurrentScene&&this.root.addChild(a._pixiObj),this.sceneView&&(a._pixiObjInScene=new PIXI.DisplayObjectContainer,Engine._canModifyCurrentScene&&this.sceneView.root.addChild(a._pixiObjInScene))},a.prototype.onEntityRemoved=function(a){a._pixiObj&&(a._pixiObj.parent&&a._pixiObj.parent.removeChild(a._pixiObj),a._pixiObj=null),a._pixiObjInScene&&(a._pixiObjInScene.parent&&a._pixiObjInScene.parent.removeChild(a._pixiObjInScene),a._pixiObjInScene=null)},a.prototype.onEntityParentChanged=function(a,b){a._pixiObj&&(a._parent?a._parent._pixiObj.addChild(a._pixiObj):this.root.addChild(a._pixiObj)),this.sceneView&&(a._parent?a._parent._pixiObjInScene.addChild(a._pixiObjInScene):this.sceneView.root.addChild(a._pixiObjInScene))},a._getChildrenOffset=function(a,b,c){if(a){var d=b?a._pixiObjInScene:a._pixiObj,e=c||a._children[0];if(e){var f=b?e._pixiObjInScene:e._pixiObj,g=d.children.indexOf(f);return-1!==g?g:c?d.children.length:(Fire.error("%s's pixi object not contains in its pixi parent's children",e.name),-1)}return d.children.length}return 0},a.prototype.onEntityIndexChanged=function(b,c,d){var e=null,f=0,g=null;0===d&&c>0?g=b.getSibling(1):0===c&&d>0&&(g=b);var h=0,i=b._pixiObj;i&&(f=a._getChildrenOffset(b._parent,!1,g),e=i.parent.children,e.splice(c+f,1),h=d+f,h<e.length?e.splice(h,0,i):e.push(i)),this.sceneView&&(f=a._getChildrenOffset(b._parent,!0,g),i=b._pixiObjInScene,e=i.parent.children,e.splice(c+f,1),h=d+f,h<e.length?e.splice(h,0,i):e.push(i))},a.prototype.onSceneLaunched=function(a){for(var b=a.entities,c=0,d=b.length;d>c;c++){var e=b[c]._pixiObj;e&&this.root.addChild(e)}if(this.sceneView)for(c=0;d>c;c++)this.sceneView.root.addChild(b[c]._pixiObjInScene)},a.prototype.onSceneLoaded=function(a){for(var b=a.entities,c=0,d=b.length;d>c;c++)this.onEntityCreated(b[c],!1)};var d=function(a,b){a._pixiObj=new PIXI.DisplayObjectContainer,a._parent._pixiObj.addChild(a._pixiObj),b&&(a._pixiObjInScene=new PIXI.DisplayObjectContainer,a._parent._pixiObjInScene.addChild(a._pixiObjInScene));for(var c=a._children,e=0,f=c.length;f>e;e++)d(c[e],b)};return a.prototype.onEntityCreated=function(a,b){a._pixiObj=new PIXI.DisplayObjectContainer,a._parent?a._parent._pixiObj.addChild(a._pixiObj):b&&this.root.addChild(a._pixiObj),this.sceneView&&(a._pixiObjInScene=new PIXI.DisplayObjectContainer,a._parent?a._parent._pixiObjInScene.addChild(a._pixiObjInScene):b&&this.sceneView.root.addChild(a._pixiObjInScene));for(var c=a._children,e=0,f=c.length;f>e;e++)d(c[e],this.sceneView)},a.prototype.addSprite=function(a){var d=b(a._sprite)||c,e=!(a.entity._objFlags&HideInGame);e&&(a._renderObj=new PIXI.Sprite(d),a.entity._pixiObj.addChildAt(a._renderObj,0)),this.sceneView&&(a._renderObjInScene=new PIXI.Sprite(d),a.entity._pixiObjInScene.addChildAt(a._renderObjInScene,0)),this.updateSpriteColor(a)},a.prototype.show=function(a,b){a._renderObj&&(a._renderObj.visible=b),a._renderObjInScene&&(a._renderObjInScene.visible=b)},a.prototype.remove=function(a){a._renderObj&&(a._renderObj.parent.removeChild(a._renderObj),a._renderObj=null),a._renderObjInScene&&(a._renderObjInScene.parent.removeChild(a._renderObjInScene),a._renderObjInScene=null)},a.prototype.updateSpriteColor=function(a){if(a._renderObj||a._renderObjInScene){var b=a._color.toRGBValue();a._renderObj&&(a._renderObj.tint=b),a._renderObjInScene&&(a._renderObjInScene.tint=b)}else Fire.error(""+a+" must be added to render context first!")},a.prototype.updateMaterial=function(a){if(a._renderObj||a._renderObjInScene){var d=b(a._sprite)||c;a._renderObj&&a._renderObj.setTexture(d),a._renderObjInScene&&a._renderObjInScene.setTexture(d)}else Fire.error(""+a+" must be added to render context first!")},a.prototype.updateTransform=function(a,b){var c=a._tempMatrix;c.a=b.a,c.b=-b.b,c.c=-b.c,c.d=b.d,c.tx=b.tx,c.ty=this.renderer.height-b.ty;var d=this===Engine._renderContext;if(d){if(a._renderObj)return a._renderObj.worldTransform=c,void(a._renderObj.worldAlpha=a._color.a)}else if(a._renderObjInScene)return a._renderObjInScene.worldTransform=c,void(a._renderObjInScene.worldAlpha=a._color.a);Fire.error(""+a+" must be added to render context first!")},a}();RenderContext.prototype.checkMatchCurrentScene=function(){function a(b,c,d){if(d&&b._pixiObjInScene!==d)throw new Error("entity does not match pixi scene node: "+b.name);if(b._pixiObj!==c)throw new Error("entity does not match pixi game node: "+b.name);var e=b._children.length,f;if(d&&(f=RenderContext._getChildrenOffset(b,!0),d.children.length!==e+f))throw console.error("Mismatched list of child elements in Scene view, entity: %s,\npixi childCount: %s, entity childCount: %s, rcOffset: %s",b.name,d.children.length,e,f),new Error("(see above error)");var g=RenderContext._getChildrenOffset(b,!1);if(c.children.length!==e+g)throw new Error("Mismatched list of child elements in Game view, entity: "+b.name);for(var h=0;e>h;h++)a(b._children[h],c.children[g+h],d&&d.children[h+f])}var b=Engine._scene.entities,c=this.stage.children,d;this.sceneView&&(d=this.sceneView.stage.children,d=d[1].children);for(var e=0;e<b.length;e++){if(d&&d.length!==b.length)throw new Error("Mismatched list of root elements in scene view");if(c.length!==b.length)throw new Error("Mismatched list of root elements in game view");a(b[e],c[e],d&&d[e])}},Fire._RenderContext=RenderContext,PIXI.BitmapText.prototype.updateTransform=function(){};var PixiBitmapFontUtil={},emptyFont={face:"None",size:1,align:"left"};RenderContext.prototype.getTextSize=function(a){var b=!(a.entity._objFlags&HideInGame),c=0,d=0;return b&&a._renderObj?(c=a._renderObj.textWidth,d=a._renderObj.textHeight):a._renderObjInScene&&(c=a._renderObjInScene.textWidth,d=a._renderObjInScene.textHeight),new Vec2(c,d)},RenderContext.prototype.setText=function(a,b){a._renderObj&&a._renderObj.setText(b),this.sceneView&&a._renderObjInScene.setText(b)},RenderContext.prototype.setAlign=function(a){_setStyle(a)},RenderContext.prototype.setBitmapFont=function(a){_registerFont(a.bitmapFont),_setStyle(a)},RenderContext.prototype.addBitmapText=function(a){_registerFont(a.bitmapFont);var b=_getStyle(a),c=!(a.entity._objFlags&HideInGame);c&&(a._renderObj=new PIXI.BitmapText(a.text,b),a.entity._pixiObj.addChildAt(a._renderObj,0)),this.sceneView&&(a._renderObjInScene=new PIXI.BitmapText(a.text,b),a.entity._pixiObjInScene.addChildAt(a._renderObjInScene,0))},PixiBitmapFontUtil.updateTransform=function(a,b){var c=0,d=null,e=0,f=null,g=Engine._curRenderContext===Engine._renderContext;if(g)for(a._renderObj.dirty&&(a._renderObj.updateText(),a._renderObj.dirty=!1),d=a._renderObj.children,e=d.length;e>c;c++)f=d[c],f.worldTransform=_getNewMatrix23(f,b);else if(a._renderObjInScene)for(a._renderObjInScene.dirty&&(a._renderObjInScene.updateText(),a._renderObjInScene.dirty=!1),d=a._renderObjInScene.children,c=0,e=d.length;e>c;c++)f=d[c],f.worldTransform=_getNewMatrix23(f,b)};var FireUrl=Fire.isNode?require("fire-url"):null;Fire._JsonLoader=JsonLoader;var Component=function(){var a=Fire.define("Fire.Component",HashObject,function(){HashObject.call(this),Fire._AssetsWatcher.initComponent(this)});a.prop("entity",null,Fire.HideInInspector),a.prop("_enabled",!0,Fire.HideInInspector),Object.defineProperty(a.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled!=a&&(this._enabled=a,this.entity._activeInHierarchy&&b(this,a))}}),Object.defineProperty(a.prototype,"enabledInHierarchy",{get:function(){return this._enabled&&this.entity._activeInHierarchy}}),Object.defineProperty(a.prototype,"transform",{get:function(){return this.entity.transform}}),a.prototype.update=null,a.prototype.lateUpdate=null,a.prototype.onLoad=null,a.prototype.onStart=null,a.prototype.onEnable=null,a.prototype.onDisable=null,a.prototype.onDestroy=null,a.prototype.onPreRender=null,a.prototype.destroy=function(){FObject.prototype.destroy.call(this)&&this._enabled&&this.entity._activeInHierarchy&&b(this,!1)};var b=function(a,b){(Fire.Engine.isPlaying||Fire.attr(a,"executeInEditMode"))&&(b?a._objFlags&IsOnEnableCalled||(a._objFlags|=IsOnEnableCalled,a.onEnable&&a.onEnable(),editorCallback.onComponentEnabled&&editorCallback.onComponentEnabled(a)):a._objFlags&IsOnEnableCalled&&(a._objFlags&=~IsOnEnableCalled,a.onDisable&&a.onDisable(),editorCallback.onComponentDisabled&&editorCallback.onComponentDisabled(a)))};return a.prototype._onEntityActivated=function(a){this._objFlags&IsOnLoadCalled||!Fire.Engine.isPlaying&&!Fire.attr(this,"executeInEditMode")||(this._objFlags|=IsOnLoadCalled,this.onLoad&&this.onLoad(),Fire._AssetsWatcher.start(this)),this._enabled&&b(this,a)},a._invokeStarts=function(b){var c=b._components.length,d=0,e=null;if(Fire.Engine.isPlaying)for(;c>d;++d)e=b._components[d],e._objFlags&IsOnStartCalled||(e._objFlags|=IsOnStartCalled,e.onStart&&e.onStart());else for(;c>d;++d)e=b._components[d],e._objFlags&IsOnStartCalled||!Fire.attr(e,"executeInEditMode")||(e._objFlags|=IsOnStartCalled,e.onStart&&e.onStart());for(var f=0,g=b._children,h=g.length;h>f;++f){var i=[f];i._active&&a._invokeStarts(i)}},a.prototype._onPreDestroy=function(){b(this,!1),Fire._AssetsWatcher.stop(this),(Fire.Engine.isPlaying||Fire.attr(this,"executeInEditMode"))&&this.onDestroy&&this.onDestroy(),this.entity._removeComponent(this)},a}();Fire.Component=Component,Fire._componentMenuItems=[],Fire.addComponentMenu=function(a,b,c){Fire._componentMenuItems.push({component:a,menuPath:b,priority:c})},Fire.attr(Component,"executeInEditMode",!1),Fire.executeInEditMode=function(a){Fire.attr(a,"executeInEditMode",!0)};var _requiringFrame=[];Fire._RFpush=function(a,b){1===arguments.length&&(b=a,a=""),_requiringFrame.push({uuid:a,script:b})},Fire._RFpop=function(){_requiringFrame.pop()},Fire.defineComponent=function(a,b){var c=[""];if(0===arguments.length)c.push(Component);else if(1===arguments.length)if(Fire.isChildClassOf(a,Component))c.push(a);else{if(Fire._isFireClass(a))return void Fire.error("[Fire.defineComponent] Base class must inherit from Component");if("function"!=typeof a)return void Fire.error("[Fire.defineComponent] Constructor must be function type");c.push(Component),c.push(a)}else{if(!Fire.isChildClassOf(a,Component))return void Fire.error("[Fire.defineComponent] Base class must inherit from Component");if("function"!=typeof b)return void Fire.error("[Fire.defineComponent] Constructor must be function type");c.push(a),c.push(b)}var d=_requiringFrame[_requiringFrame.length-1];if(d){var e=d.script;c[0]=e;var f=Fire.define.apply(Fire,c);return d.uuid&&Fire._setClassId(d.uuid,f),f}Fire.error("[Fire.defineComponent] Sorry, defining Component dynamically is not allowed, define during loading script please.")};var Transform=function(){var a=Fire.define("Fire.Transform",Component,function(){Component.call(this),this._position=new Vec2(0,0),this._scale=new Vec2(1,1),this._worldTransform=new Matrix23,this._parent=null});return Fire.executeInEditMode(a),a.prop("_position",null,Fire.HideInInspector),a.prop("_rotation",0,Fire.HideInInspector),a.prop("_scale",null,Fire.HideInInspector),a.getset("position",function(){return new Vec2(this._position.x,this._position.y)},function(a){this._position.x=a.x,this._position.y=a.y},Fire.Tooltip("The local position in its parent's coordinate system")),Object.defineProperty(a.prototype,"worldPosition",{get:function(){var a=this.getLocalToWorldMatrix();return new Vec2(a.tx,a.ty)},set:function(a){if(this._parent){var b=this._parent.getWorldToLocalMatrix();this.position=b.transformPoint(a)}else this.position=a}}),a.getset("rotation",function(){return this._rotation},function(a){this._rotation=a},Fire.Tooltip("The counterclockwise degrees of rotation relative to the parent")),Object.defineProperty(a.prototype,"worldRotation",{get:function(){return this._parent?this.rotation+this._parent.worldRotation:this.rotation},set:function(a){this.rotation=this._parent?a-this._parent.worldRotation:a}}),a.getset("scale",function(){return new Vec2(this._scale.x,this._scale.y)},function(a){this._scale.x=a.x,this._scale.y=a.y},Fire.Tooltip("The local scale factor relative to the parent")),Object.defineProperty(a.prototype,"worldScale",{get:function(){var a=this.getLocalToWorldMatrix();return a.getScale()}}),Object.defineProperty(a.prototype,"parent",{get:function(){return Fire.error("Transform.parent is obsolete. Use Entity.parent instead."),null},set:function(a){Fire.error("Transform.parent is obsolete. Use Entity.parent instead.")}}),a.prototype.onLoad=function(){this._parent=this.entity._parent&&this.entity._parent.transform},a.prototype.destroy=function(){Fire.error("Not allowed to destroy the transform. Please destroy the entity instead.")},a.prototype._updateTransform=function(a){var b=this._worldTransform;this.getLocalMatrix(b),b.prepend(a);for(var c=this.entity._children,d=0,e=c.length;e>d;d++)c[d].transform._updateTransform(b)},a.prototype._updateRootTransform=function(){var a=this._worldTransform;this.getLocalMatrix(a);for(var b=this.entity._children,c=0,d=b.length;d>c;c++)b[c].transform._updateTransform(a)},a.prototype.getLocalMatrix=function(a){a=a||new Matrix23;var b=.017453292519943295*this._rotation,c=0===this._rotation?0:Math.sin(b),d=0===this._rotation?1:Math.cos(b);return a.a=this._scale.x*d,a.b=this._scale.x*c,a.c=this._scale.y*-c,a.d=this._scale.y*d,a.tx=this._position.x,a.ty=this._position.y,a},a.prototype.getLocalToWorldMatrix=function(a){a=a||new Matrix23,this.getLocalMatrix(a);for(var b=new Fire.Matrix23,c=this._parent;null!==c;c=c._parent)a.prepend(c.getLocalMatrix(b));return a},a.prototype.getWorldToLocalMatrix=function(a){return this.getLocalToWorldMatrix(a).invert()},a.prototype.rotateAround=function(a,b){var c=this.worldPosition.subSelf(a);c.rotateSelf(Math.deg2rad(b)),this.worldPosition=a.addSelf(c),this.rotation=this._rotation+b},Object.defineProperty(a.prototype,"up",{get:function(){return new Vec2(0,1).rotateSelf(Math.deg2rad(this.worldRotation))},set:function(a){if(0===a.x&&0===a.y)return void Fire.warn("Can't get rotation from zero vector");var b=Math.atan2(a.y,a.x)-Math.HALF_PI;this.worldRotation=Math.rad2deg(b)}}),Object.defineProperty(a.prototype,"right",{get:function(){return new Vec2(1,0).rotateSelf(Math.deg2rad(this.worldRotation))},set:function(a){if(0===a.x&&0===a.y)return void Fire.warn("Can't get rotation from zero vector");var b=Math.atan2(a.y,a.x);this.worldRotation=Math.rad2deg(b)}}),a}();Fire.Transform=Transform;var Renderer=function(){function a(a,b,d,e,f){var g=this.getWorldSize(),h=g.x,i=g.y;this.getSelfMatrix(c),a=c.prepend(a);var j=a.tx,k=a.ty,l=a.a*h,m=a.b*h,n=a.c*-i,o=a.d*-i;d.x=j,d.y=k,e.x=l+j,e.y=m+k,b.x=n+j,b.y=o+k,f.x=l+n+j,f.y=m+o+k}var b=Fire.define("Fire.Renderer",Component),c=new Fire.Matrix23;return b.prototype.getWorldBounds=function(b){var c=this.entity.transform.getLocalToWorldMatrix(),d=new Vec2(0,0),e=new Vec2(0,0),f=new Vec2(0,0),g=new Vec2(0,0);return a.call(this,c,d,e,f,g),b=b||new Rect,Math.calculateMaxRect(b,d,e,f,g),b},b.prototype.getWorldOrientedBounds=function(b,c,d,e){b=b||new Vec2(0,0),c=c||new Vec2(0,0),d=d||new Vec2(0,0),e=e||new Vec2(0,0);var f=this.entity.transform.getLocalToWorldMatrix();return a.call(this,f,b,c,d,e),[b,c,d,e]},b.prototype.getSelfMatrix=function(a){},b.prototype.getWorldSize=function(){return new Vec2(0,0)},b}();Fire.Renderer=Renderer;var SpriteRenderer=function(){var a=Fire.define("Fire.SpriteRenderer",Renderer,function(){Renderer.call(this),RenderContext.initRenderer(this),this._hasRenderObj=!1});Fire.addComponentMenu(a,"SpriteRenderer"),Fire.executeInEditMode(a),a.prop("_sprite",null,Fire.HideInInspector),a.getset("sprite",function(){return this._sprite},function(a){this._sprite=a,this._hasRenderObj&&Engine._renderContext.updateMaterial(this)},Fire.ObjectType(Fire.Sprite)),a.prop("_color",new Fire.Color(1,1,1,1),Fire.HideInInspector),a.getset("color",function(){return this._color},function(a){this._color=a,this._hasRenderObj&&Engine._renderContext.updateSpriteColor(this)}),a.prop("customSize_",!1,Fire.HideInInspector),a.getset("customSize",function(){return this.customSize_},function(a){this.customSize_=a}),a.prop("width_",100,Fire.DisplayName("Width"),Fire.Watch("customSize_",function(a,b){b.disabled=!a.customSize})),a.getset("width",function(){return this.customSize_?this.width_:Fire.isValid(this._sprite)?this._sprite.width:0},function(a){this.width_=a},Fire.HideInInspector),a.prop("height_",100,Fire.DisplayName("Height"),Fire.Watch("customSize_",function(a,b){b.disabled=!a.customSize})),a.getset("height",function(){return this.customSize_?this.height_:Fire.isValid(this._sprite)?this._sprite.height:0},function(a){this.height_=a},Fire.HideInInspector),a.prototype.onLoad=function(){Engine._renderContext.addSprite(this),this._hasRenderObj=!0},a.prototype.onEnable=function(){Engine._renderContext.show(this,!0)},a.prototype.onDisable=function(){Engine._renderContext.show(this,!1)},a.prototype.getWorldSize=function(){var a=new Fire.Vec2(0,0);return a.x=this._sprite?this._sprite.width:0,a.y=this._sprite?this._sprite.height:0,a};var b=new Fire.Matrix23;return a.prototype.onPreRender=function(){this.getSelfMatrix(b),b.prepend(this.transform._worldTransform),Engine._curRenderContext.updateTransform(this,b)},a.prototype.onDestroy=function(){Engine._renderContext.remove(this)},a.prototype.getSelfMatrix=function(a){var b=this.width,c=this.height,d=.5,e=.5,f=1,g=1;Fire.isValid(this._sprite)&&(d=this._sprite.pivot.x,e=this._sprite.pivot.y,f=b/this._sprite.width,g=c/this._sprite.height),a.tx=-d*b,a.ty=(1-e)*c,a.a=f,a.b=0,a.c=0,a.d=g},a}();Fire.SpriteRenderer=SpriteRenderer;var BitmapText=function(){var a=function(a){return a[a.left=0]="Left",a[a.center=1]="Center",a[a.right=2]="Right",a}({}),b=function(a){return a[a.topLeft=0]="Top Left",a[a.topCenter=1]="Top Center",a[a.topRight=2]="Top Right",a[a.midLeft=3]="Middle Left",a[a.midCenter=4]="Middle Center",a[a.midRight=5]="Middle Right",a[a.botLeft=6]="Bottom Left",a[a.botCenter=7]="Bottom Center",a[a.botRight=8]="Bottom Right",a}({}),c=Fire.define("Fire.BitmapText",Renderer,function(){Renderer.call(this),RenderContext.initRenderer(this)});c.TextAlign=a,c.TextAnchor=b,Fire.addComponentMenu(c,"BitmapText"),Fire.executeInEditMode(c),c.prop("_bitmapFont",null,Fire.HideInInspector),c.getset("bitmapFont",function(){return this._bitmapFont},function(a){this._bitmapFont!==a&&(this._bitmapFont=a,this.face=this._bitmapFont?this._bitmapFont.face:"None",Engine._renderContext.setBitmapFont(this))},Fire.ObjectType(Fire.BitmapFont)),c.prop("_text","Text",Fire.HideInInspector),c.getset("text",function(){return this._text},function(a){this._text!==a&&(this._text="string"==typeof a?a:""+a,Engine._renderContext.setText(this,this._text))},Fire.MultiText),c.prop("_anchor",c.TextAnchor.midCenter,Fire.HideInInspector),c.getset("anchor",function(){return this._anchor},function(a){this._anchor!==a&&(this._anchor=a)},Fire.Enum(c.TextAnchor)),c.prop("_align",c.TextAlign.left,Fire.HideInInspector),c.getset("align",function(){return this._align},function(a){this._align!==a&&(this._align=a,Engine._renderContext.setAlign(this,a))},Fire.Enum(c.TextAlign)),c.prototype.onLoad=function(){Engine._renderContext.addBitmapText(this)},c.prototype.onEnable=function(){Engine._renderContext.show(this,!0)},c.prototype.onDisable=function(){Engine._renderContext.show(this,!1)},c.prototype.onDestroy=function(){Engine._renderContext.remove(this)},c.prototype.getWorldSize=function(){return Engine._renderContext.getTextSize(this)};var d=new Fire.Matrix23;return c.prototype.onPreRender=function(){this.getSelfMatrix(d),d.prepend(this.transform._worldTransform),PixiBitmapFontUtil.updateTransform(this,d)},c.prototype.getSelfMatrix=function(a){var b=Engine._renderContext.getTextSize(this),d=b.x,e=b.y,f=0,g=0;switch(this._anchor){case c.TextAnchor.topLeft:break;case c.TextAnchor.topCenter:f=d*-.5;break;case c.TextAnchor.topRight:f=-d;break;case c.TextAnchor.midLeft:g=.5*e;break;case c.TextAnchor.midCenter:f=d*-.5,g=.5*e;break;case c.TextAnchor.midRight:f=-d,g=.5*e;break;case c.TextAnchor.botLeft:g=e;break;case c.TextAnchor.botCenter:f=d*-.5,g=e;break;case c.TextAnchor.botRight:f=-d,g=e}a.a=1,a.b=0,a.c=0,a.d=1,a.tx=f,a.ty=g},c}();Fire.BitmapText=BitmapText;var Camera=function(){var a=Fire.define("Fire.Camera",Component,function(){Component.call(this),this._renderContext=null});return Fire.addComponentMenu(a,"Camera"),Fire.executeInEditMode(a),a.prop("_background",new Fire.Color(0,0,0),Fire.HideInInspector),a.getset("background",function(){return this._background},function(a){this._background=a,this._renderContext&&(this._renderContext.background=a)}),a.prop("_size",5,Fire.HideInInspector),a.getset("size",function(){return this._size},function(a){this._size=a}),Object.defineProperty(a.prototype,"renderContext",{set:function(a){this._renderContext=a,this.size=a.size.y,this._applyRenderSettings()}}),a.prototype.onLoad=function(){this.entity._objFlags&HideInGame||(this.renderContext=Engine._renderContext)},a.prototype.onEnable=function(){this.entity._objFlags&HideInGame||(Engine._scene.camera=this,this._applyRenderSettings())},a.prototype.onDisable=function(){Engine._scene.camera===this&&(Engine._scene.camera=null),this._renderContext.camera=null},a.prototype.viewportToScreen=function(a,b){return b=this._renderContext.size.scale(a,b)},a.prototype.screenToViewport=function(a,b){b=b||new Vec2;var c=this._renderContext.size;return b.x=a.x/c.x,b.y=a.y/c.y,b},a.prototype.viewportToWorld=function(a,b){return b=this.viewportToScreen(a,b),this.screenToWorld(b,b)},a.prototype.screenToWorld=function(a,b){var c=(this._renderContext||Engine._renderContext).size.mulSelf(.5),d=a.sub(c,c);d.y=-d.y;var e=new Matrix23,f=new Vec2;return this._calculateTransform(e,f),e.invert(),e.tx=f.x,e.ty=f.y,e.transformPoint(d,b)},a.prototype.worldToScreen=function(a,b){var c=new Matrix23,d=new Vec2;this._calculateTransform(c,d);var e=a.sub(d,d);b=c.transformPoint(e,b);var f=(this._renderContext||Engine._renderContext).size.y;return b.y=f-b.y,b},a.prototype.worldToViewport=function(a,b){return b=this.worldToScreen(a,b),this.screenToViewport(b,b)},a.prototype._calculateTransform=function(a,b){var c=(this._renderContext||Engine._renderContext).size,d=c.y/this._size,e=this.entity.transform,f=e.getLocalToWorldMatrix();b.x=f.tx,b.y=f.ty,a.identity(),a.tx=.5*c.x,a.ty=.5*c.y,a.a=d,a.d=d,a.rotate(f.getRotation())
},a.prototype._applyRenderSettings=function(){return this._renderContext?void(this._renderContext.background=this._background):void Fire.error("No corresponding render context for camera "+this.entity.name)},a}();Fire.Camera=Camera;var MissingScript=function(){var a=Fire.define("Fire.MissingScript",Component);return a.prototype.onLoad=function(){Fire.warn("The referenced script on this Component is missing!")},a}();Fire._MissingScript=MissingScript;var InteractionContext=function(){function a(){this.entities=[]}var b={},c={};return a.prototype._clear=function(){this.entities.length=0},a.prototype.pick=function(a){for(var d=this.entities.length-1;d>=0;--d){var e=this.entities[d];if(e.isValid){var f=b[e.id];if(f.contains(a)){var g=c[e.id],h=new Fire.Polygon(g);if(h.contains(a))return e}}}return null},a.prototype._updateRecursilvey=function(a){var d=a.getComponent(Fire.Renderer);if(d&&d._enabled){this.entities.push(a);var e=a.id;if(!c[e]){var f=d.getWorldOrientedBounds(),g=Math.calculateMaxRect(new Rect,f[0],f[1],f[2],f[3]);c[e]=f,b[e]=g}}for(var h=0,i=a._children.length;i>h;++h){var j=a._children[h];j._active&&this._updateRecursilvey(j)}},a.prototype.update=function(a){var d=!Engine.isPlaying||this===Engine._interactionContext;d&&(b={},c={}),this._clear();for(var e=0,f=a.length;f>e;++e){var g=a[e];g._active&&this._updateRecursilvey(g)}},a.prototype.getAABB=function(a){return b[a.id]},a.prototype.getOBB=function(a){return c[a.id]},a}();Fire._InteractionContext=InteractionContext;var Entity=function(){var a=Fire.define("Fire.Entity",EventTarget,function(){EventTarget.call(this);var b=arguments[0];if(this._name="undefined"!=typeof b?b:"New Entity",this._objFlags|=a._defaultFlags,Fire._isCloning)this._activeInHierarchy=!1;else{this._activeInHierarchy=!0;var c=new Transform;c.entity=this,this._components=[c],this.transform=c,Engine._scene&&Engine._scene.appendRoot(this),Engine._renderContext.onRootEntityCreated(this),editorCallback.onEntityCreated&&editorCallback.onEntityCreated(this),c._onEntityActivated(!0)}});return a.prop("_active",!0,Fire.HideInInspector),a.prop("_parent",null,Fire.HideInInspector),a.prop("_children",[],Fire.HideInInspector),a.prop("_components",null,Fire.HideInInspector),a.prop("transform",null,Fire.HideInInspector),a.getset("name",function(){return this._name},function(a){this._name=a,editorCallback.onEntityRenamed&&editorCallback.onEntityRenamed(this)}),a.getset("active",function(){return this._active},function(a){if(this._active!=a){this._active=a;var b=!this._parent||this._parent._activeInHierarchy;b&&this._onActivatedInHierarchy(a)}}),Object.defineProperty(a.prototype,"parent",{get:function(){return this._parent},set:function(b){if(this._parent!==b){if(b===this)return void Fire.warn("A entity can't be set as the parent of itself.");if(b&&!(b instanceof a))return void Fire.error(b instanceof Transform?"Entity.parent can not be a Transform, use transform.entity instead.":"Entity.parent must be instance of Entity (or must be null)");var c=this._parent;if(b){if(b._objFlags&HideInGame&&!(this._objFlags&HideInGame))return void Fire.error("Failed to set parent, the child's HideInGame must equals to parent's.");if(b._objFlags&HideInEditor&&!(this._objFlags&HideInEditor))return void Fire.error("Failed to set parent, the child's HideInEditor must equals to parent's.");c||Engine._scene.removeRoot(this),b._children.push(this)}else Engine._scene.appendRoot(this);this._parent=b||null,this.transform._parent=this._parent&&this._parent.transform,!c||c._objFlags&Destroying||(c._children.splice(c._children.indexOf(this),1),this._onHierarchyChanged(c)),Engine._renderContext.onEntityParentChanged(this,c),editorCallback.onEntityParentChanged&&editorCallback.onEntityParentChanged(this)}}}),Object.defineProperty(a.prototype,"childCount",{get:function(){return this._children.length}}),a._defaultFlags=0,a.find=function(a){return a||""===a?"/"!==a[0]?void Fire.error("Path must start with a '/' character"):Engine._scene.findEntity(a):void Fire.error("Argument must be non-nil")},Object.defineProperty(a.prototype,"activeInHierarchy",{get:function(){return this._activeInHierarchy}}),a.prototype.destroy=function(){FObject.prototype.destroy.call(this)&&this._activeInHierarchy&&this._deactivateChildComponents()},a.prototype._onPreDestroy=function(){var a=this._parent;this._objFlags|=Destroying;var b=!(a&&a._objFlags&Destroying);b&&(Engine._renderContext.onEntityRemoved(this),editorCallback.onEntityRemoved&&editorCallback.onEntityRemoved(this));for(var c=0;c<this._components.length;++c){var d=this._components[c];d._destroyImmediate()}a?b&&a._children.splice(a._children.indexOf(this),1):Engine._scene.removeRoot(this);for(var e=this._children,f=0,g=e.length;g>f;++f)e[f]._destroyImmediate()},a.prototype._getCapturingTargets=function(a,b){for(var c=this._parent;c;c=c._parent)c._activeInHierarchy&&c._capturingListeners&&c._capturingListeners.has(a)&&b.push(c)},a.prototype._getBubblingTargets=function(a,b){for(var c=this._parent;c;c=c._parent)c._activeInHierarchy&&c._bubblingListeners&&c._bubblingListeners.has(a)&&b.push(c)},a.prototype._doSendEvent=function(b){this._activeInHierarchy&&a.$super.prototype._doSendEvent.call(this,b)},a.prototype.addComponent=function(a){if(this._objFlags&Destroying)return void Fire.error("isDestroying");if(!a)return void Fire.error("Argument must be non-nil");if("function"!=typeof a)return void Fire.error("The component to add must be a constructor");var b=new a;return b.entity=this,this._components.push(b),this._activeInHierarchy&&b._onEntityActivated(!0),b},a.prototype.getComponent=function(a){if(!a)return void Fire.error("Argument must be non-nil");var b;b="string"==typeof a?Fire.getClassByName(a):a;for(var c=0;c<this._components.length;++c){var d=this._components[c];if(d instanceof b)return d}return null},a.prototype._removeComponent=function(a){if(!(this._objFlags&Destroying)){var b=this._components.indexOf(a);-1!==b?(this._components.splice(b,1),a.entity=null):a.entity!==this&&Fire.error("Component not owned by this entity")}},a.prototype.find=function(a){if(!a&&""!==a)return void Fire.error("Argument must be non-nil");if("/"===a[0])return void Fire.error("Path should not start with a '/' character, please use \"Fire.Entity.find\" instead");for(var b=a.split("/"),c=this,d=0,e=0,f=null,g=null,h=0;h<b.length;h++){var i=b[h];if(".."===i){if(!c)return null;c=c._parent}else{for(f=c?c._children:Engine._scene.entities,c=null,d=0,e=f.length;e>d;++d)g=f[d],g.name===i&&(c=g);if(!c)return null}}return c},a.prototype.getChild=function(a){return this._children[a]},a.prototype.isChildOf=function(a){var b=this;do{if(b===a)return!0;b=b._parent}while(b);return!1},a.prototype.getSiblingIndex=function(){return this._parent?this._parent._children.indexOf(this):Engine._scene.entities.indexOf(this)},a.prototype.getSibling=function(a){return this._parent?this._parent._children[a]:Engine._scene.entities[a]},a.prototype.setSiblingIndex=function(a){var b=this._parent?this._parent._children:Engine._scene.entities,c=this;a=-1!==a?a:b.length-1;var d=b.indexOf(c);a!==d&&(b.splice(d,1),a<b.length?b.splice(a,0,c):b.push(c),Engine._renderContext.onEntityIndexChanged(this,d,a),editorCallback.onEntityIndexChanged&&editorCallback.onEntityIndexChanged(this,d,a))},a.prototype.setAsFirstSibling=function(){this.setSiblingIndex(0)},a.prototype.setAsLastSibling=function(){this.setSiblingIndex(-1)},a.prototype._onActivatedInHierarchy=function(a){this._activeInHierarchy=a;for(var b=this._components.length,c=0;b>c;++c){var d=this._components[c];d._onEntityActivated(a)}for(var e=0,f=this.childCount;f>e;++e){var g=this._children[e];g._active&&g._onActivatedInHierarchy(a)}},a.prototype._deactivateChildComponents=function(){for(var a=this._components.length,b=0;a>b;++b){var c=this._components[b];c._onEntityActivated(!1)}for(var d=0,e=this.childCount;e>d;++d){var f=this._children[d];f._active&&f._deactivateChildComponents()}},a.prototype._onHierarchyChanged=function(a){var b=this._active&&(!a||a._activeInHierarchy),c=this._active&&(!this._parent||this._parent._activeInHierarchy);b!==c&&this._onActivatedInHierarchy(c)},a.prototype._instantiate=function(a,b){var c=this._parent;this._parent=null;var d=Fire._doInstantiate(this);return this._parent=c,Engine.isPlaying&&(d._name=this._name+"(Clone)"),a&&(d.transform._position=a),b&&(d.transform._rotation=b),Engine._scene&&Engine._scene.appendRoot(d),Engine._renderContext.onEntityCreated(d,!0),editorCallback.onEntityCreated&&editorCallback.onEntityCreated(d),d._active&&d._onActivatedInHierarchy(!0),d},a}();Fire.Entity=Entity;var Scene=function(){function Scene(){_super.call(this),this.entities=[],this.camera=null}var _super=Asset;Fire.extend(Scene,_super),Fire.setClassName("Fire.Scene",Scene);var visitOperationTmpl="if(c._enabled && c._FUNC_) c._FUNC_();";visitOperationTmpl="if(c._enabled && c._FUNC_ && (Fire.Engine.isPlaying || Fire.attr(c,'executeInEditMode'))) c._FUNC_();";var visitFunctionTmpl="(function(e){	var i, len=e._components.length;	for(i=0;i<len;++i){		var c=e._components[i];		"+visitOperationTmpl+"	}	var cs=e._children;	for(i=0,len=cs.length;i<len;++i){		var sub=cs[i];		if(sub._active) _FUNC_Recursively(sub);	}})",updateRecursively=eval(visitFunctionTmpl.replace(/_FUNC_/g,"update")),lateUpdateRecursively=eval(visitFunctionTmpl.replace(/_FUNC_/g,"lateUpdate")),onPreRenderRecursively=eval(visitFunctionTmpl.replace(/_FUNC_/g,"onPreRender"));return Scene.prototype.update=function(){for(var a=this.entities,b=0,c=a.length;c>b;++b)Component._invokeStarts(a[b]);for(b=0,c=a.length;c>b;++b)a[b]._active&&updateRecursively(a[b]);for(b=0,c=a.length;c>b;++b)a[b]._active&&lateUpdateRecursively(a[b])},Scene.prototype.render=function(a){Engine._curRenderContext=a,this.updateTransform(a.camera||this.camera);for(var b=this.entities,c=0,d=b.length;d>c;++c)b[c]._active&&onPreRenderRecursively(b[c]);a.render(),Engine._curRenderContext=null},Scene.prototype.updateTransform=function(a){var b=this.entities,c,d;if(a){var e=new Matrix23,f=new Vec2;a._calculateTransform(e,f);var g=-f.x,h=-f.y;for(c=0,d=b.length;d>c;++c){var i=b[c].transform._position,j=i.x,k=i.y;i.x+=g,i.y+=h,b[c].transform._updateTransform(e),i.x=j,i.y=k}}else for(c=0,d=b.length;d>c;++c)b[c].transform._updateRootTransform()},Scene.prototype.appendRoot=function(a){this.entities.push(a)},Scene.prototype.removeRoot=function(a){var b=this.entities;if(b.length>0&&b[b.length-1]===a)return void b.pop();var c=b.indexOf(a);-1!==c?b.splice(c,1):Fire.error("entity "+a+" not contains in roots of hierarchy")},Scene.prototype.findEntity=function(a){for(var b=a.split("/"),c=null,d=b[1],e=this.entities,f=0;f<e.length;f++)if(e[f].isValid&&e[f]._name===d){c=e[f];break}if(!c)return null;var g=2;for(g;g<b.length;g++){d=b[g];var h=c._children;c=null;for(var i=0,j=h.length;j>i;++i){var k=h[i];if(k.name===d){c=k;break}}if(!c)return null}return c},Scene.prototype.activate=function(){for(var a=this.entities,b=0,c=a.length;c>b;++b){var d=a[b];d._active&&d._onActivatedInHierarchy(!0)}if(Engine.isPlaying)for(b=0,c=a.length;c>b;++b)Component._invokeStarts(a[b])},Scene.prototype.destroy=function(){for(var a=this.entities,b=0,c=a.length;c>b;++b){var d=a[b];d.isValid&&d.destroy()}_super.prototype.destroy.call(this)},Scene.prototype._instantiate=function(){var a=this._uuid,b=Fire._doInstantiate(this);return b._uuid=a,b},Scene}();Fire._Scene=Scene;var LoadManager=function(){function a(){return{image:{loader:ImageLoader,defaultExtname:".host"},json:{loader:JsonLoader,defaultExtname:".json"},text:{loader:TextLoader,defaultExtname:".txt"}}}function b(a,b,c){f._curConcurrent+=1,a(b,function d(a,b){c(a,b),f._curConcurrent=Math.max(0,f._curConcurrent-1),e()})}var c=new Fire.CallbacksInvoker,d=[],e=function(){if(f._curConcurrent>=f.maxConcurrent)return void Fire.error("too many concurrent requests");var a=d.pop();a&&b(a.loader,a.url,a.callback)},f={maxConcurrent:2,_curConcurrent:0,loadByLoader:function(a,e,f){if(c.add(e,f)){var g=c.bindKey(e,!0);this._curConcurrent<this.maxConcurrent?b(a,e,g):d.push({url:e,loader:a,callback:g})}},load:function(a,b,c,d){"function"==typeof c&&(d=c);var e=this._rawTypes[b];if(e){var f=c?"."+c:e.defaultExtname;if(f){var g=a+f;this.loadByLoader(e.loader,g,d)}else d(null,"Undefined extname for the raw "+b+" file of "+a)}else d(null,'Unknown raw type "'+b+'" of '+a)},_rawTypes:a(),registerRawTypes:function(a,b,c){return a?"string"!=typeof a?void Fire.error("[AssetLibrary.registerRawTypes] rawType must be string"):b?"function"!=typeof b?void Fire.error("[AssetLibrary.registerRawTypes] loader must be function"):this._rawTypes[a]?void Fire.error('rawType "%s" has already defined',a):(c&&"."!==c[0]&&(c="."+c),void(this._rawTypes[a]={loader:b,defaultExtname:c})):void Fire.error("[AssetLibrary.registerRawTypes] loader must be non-nil"):void Fire.error("[AssetLibrary.registerRawTypes] rawType must be non-nil")},reset:function(){this._rawTypes=a()},_loadFromXHR:_LoadFromXHR};return f._urlToCallbacks=c,f}();Fire.LoadManager=LoadManager;var AssetLibrary=function(){var a={},b="",c=new Fire.CallbacksInvoker,d={_loadAssetByUuid:function(e,f,g,h){if(g="undefined"!=typeof g?g:!1,"string"!=typeof e)return void f(null,"[AssetLibrary] uuid must be string");var i=d._uuidToAsset[e];if(i)return void(f&&f(i));if(g||c.add(e,f)!==!1){var j=a&&a[e];j||(j=b+e.substring(0,2)+Fire.Path.sep+e),LoadManager.loadByLoader(JsonLoader,j,function(a,b){return b?void(g?f(null,b):c.invokeAndRemove(e,null,b)):void d.loadJson(a,j,function(a){a._uuid=e,g?f(a,b):(d._uuidToAsset[e]=a,c.invokeAndRemove(e,a))},g,h)})}},loadJson:function(a,b,c,e,f){f?f.reset():f=new Fire._DeserializeInfo,Engine._canModifyCurrentScene=!1;var g=a&&a[0]&&a[0].__type__===Fire._getClassId(Scene),h=Fire.deserialize(a,f,{classFinder:g?Fire._MissingScript.safeFindClass:function(a){var b=Fire._getClassById(a);return b?b:(Fire.warn('Can not get class "%s"',a),Object)}});Engine._canModifyCurrentScene=!0;var i=f.uuidList.length,j=f.rawProp;if(j){var k=Fire.attr(h.constructor,f.rawProp),l=k.rawType;++i,LoadManager.load(b,l,h._rawext,function q(a,d){d&&Fire.error("[AssetLibrary] Failed to load %s of %s. %s",l,b,d),h[j]=a,--i,0===i&&c(h)})}if(0===i)return void c(h);for(var m=0,n=f.uuidList.length;n>m;m++){var o=f.uuidList[m],p=function(a,b,d){return function(e,f){f?Fire.error('[AssetLibrary] Failed to load "'+a+'", '+f):e._uuid=a,b[d]=e,--i,0===i&&c(h)}}(o,f.uuidObjList[m],f.uuidPropList[m]);d._loadAssetByUuid(o,p,e,f)}},loadAsset:function(a,b){this._loadAssetByUuid(a,b,!0,null)},getAssetByUuid:function(a){return d._uuidToAsset[a]||null},unloadAsset:function(a,b){var c;c="string"==typeof a?d._uuidToAsset[a]:a,c&&(b&&c.isValid&&c.destroy(),delete d._uuidToAsset[c._uuid])},init:function(c,d){return b&&!Fire.isUnitTest?void Fire.error("AssetLibrary has already been initialized!"):(b=Fire.Path.setEndWithSep(c),void(a=d))}};return d._uuidToAsset={},Asset.prototype._onPreDestroy&&Fire.error("_onPreDestroy of Asset has already defined"),Asset.prototype._onPreDestroy=function(){d._uuidToAsset[this._uuid]===this&&d.unloadAsset(this,!1)},d}();Fire.AssetLibrary=AssetLibrary;var Engine=function(){var a={_editorCallback:editorCallback},b=!1,c=!1,d=!1,e=!1,f=-1;a._scene=null,a._renderContext=null,a._interactionContext=null,a._curRenderContext=null,a._inputContext=null,Object.defineProperty(a,"isPlaying",{get:function(){return b}}),Object.defineProperty(a,"isPaused",{get:function(){return c}}),Object.defineProperty(a,"isLoadingScene",{get:function(){return e}});var g=null;Object.defineProperty(a,"_canModifyCurrentScene",{get:function(){return!g},set:function(a){a?(this._scene=g,g=null):(this._scene&&g&&Fire.error("another scene still locked: "+g.name),g=this._scene,this._scene=null)}}),Object.defineProperty(a,"screenSize",{get:function(){return a._renderContext.size},set:function(b){a._renderContext.size=b}});var h=!1;Object.defineProperty(a,"inited",{get:function(){return h}}),a.init=function(b,c,d){return h?void Fire.error("Engine already inited"):(h=!0,a._renderContext=new RenderContext(b,c,d),a._interactionContext=new InteractionContext,Fire.isEditor===!1&&(a._scene=new Scene,editorCallback.onSceneLaunched&&editorCallback.onSceneLaunched(a._scene)),a._renderContext)},a.play=function(){if(b&&!c)return void Fire.warn("Fireball is already playing");if(b&&c)return c=!1,void(editorCallback.onEnginePlayed&&editorCallback.onEnginePlayed(!0));b=!0,a._inputContext=new InputContext(a._renderContext);var d=Ticker.now();Time._restart(d),k(),editorCallback.onEnginePlayed&&editorCallback.onEnginePlayed(!1)},a.stop=function(){b&&(FObject._deferredDestroy(),a._inputContext.destruct(),a._inputContext=null,Input._reset()),b=!1,c=!1,e=!1,-1!==f&&(Ticker.cancelAnimationFrame(f),f=-1),editorCallback.onEngineStopped&&editorCallback.onEngineStopped()},a.pause=function(){c=!0,editorCallback.onEnginePaused&&editorCallback.onEnginePaused()},a.step=function(){this.pause(),d=!0,b||a.play()};var i=function(){a._scene.render(a._renderContext),Fire.isPureWeb&&a._renderContext.sceneView&&a._scene.render(a._renderContext.sceneView)},j=function(b){a._scene&&(b&&(a._scene.update(),FObject._deferredDestroy()),i(),a._interactionContext.update(a._scene.entities))},k=function(a){if(b&&(f=Ticker.requestAnimationFrame(k),!e)){var g=!c||d;d=!1;var h=Ticker.now();Time._update(h,!g),j(g),__TESTONLY__.update&&__TESTONLY__.update(g)}};return a.update=k,a._setCurrentScene=function(b,c){if(!b)return void Fire.error("Argument must be non-nil");var d=a._scene;AssetLibrary.unloadAsset(d),Fire.isValid(d)&&(d.destroy(),FObject._deferredDestroy()),a._scene=null,c&&c(),a._renderContext.onSceneLoaded(b),a._scene=b,a._renderContext.onSceneLaunched(b),editorCallback.onSceneLaunched&&editorCallback.onSceneLaunched(b),b.activate()},a.loadScene=function(b,c,d){e=!0,AssetLibrary._loadAssetByUuid(b,function f(g,h){return h?(Fire.error("Failed to load scene: "+h),console["throw"]("[test] Failed to load scene"),e=!1,void(c&&c(null,h))):g instanceof Fire._Scene?(a._setCurrentScene(g,d),e=!1,void(c&&c(g))):(h="The asset "+b+" is not a scene",Fire.error(h),e=!1,void(c&&c(null,h)))})},a}();Fire.Engine=Engine;var ModifierKeyStates=function(){function a(a,b){Fire.Event.call(this,a,!0),this.initFromNativeEvent(b)}return Fire.extend(a,Fire.Event),a.prototype.getModifierState=function(a){return nativeEvent.getModifierState(a)},a.prototype.initFromNativeEvent=function(a){this.ctrlKey=a.ctrlKey,this.shiftKey=a.shiftKey,this.altKey=a.altKey,this.metaKey=a.metaKey,this.nativeEvent=a},a.prototype._reset=function(){Event.prototype._reset.call(this),this.nativeEvent=null,this.ctrlKey=!1,this.shiftKey=!1,this.altKey=!1,this.metaKey=!1},a}();Fire.ModifierKeyStates=ModifierKeyStates,Fire.KeyboardEvent=KeyboardEvent;var MouseEvent=function(){function a(a,b){Fire.ModifierKeyStates.call(this,a,b)}return Fire.extend(a,ModifierKeyStates),a.prototype.initFromNativeEvent=function(a){ModifierKeyStates.prototype.initFromNativeEvent.call(this,a),this.button=a.button,this.buttonStates=a.buttons,this.screenX=a.offsetX,this.screenY=a.offsetY,this.deltaX=a.movementX,this.deltaY=a.movementY,this.relatedTarget=a.relatedTarget},a.prototype._reset=function(){ModifierKeyStates.prototype._reset.call(this),this.button=0,this.buttonStates=0,this.screenX=0,this.screenY=0,this.deltaX=0,this.deltaY=0,this.relatedTarget=null},a}();Fire.MouseEvent=MouseEvent;var InputContext=function(){function a(a){this.target=a,this.events=[]}a.prototype.addEventListener=function(a,b,c){this.target.addEventListener(a,b,c),this.events.push([a,b,c])},a.prototype.removeAll=function(){for(var a=0;a<this.events.length;a++){var b=this.events[a];this.target.removeEventListener(b[0],b[1],b[2])}this.events.length=0};var b=function(b){var c=b.renderer.view;c.tabIndex=c.tabIndex||0,this.renderContext=b,this.eventRegister=new a(c);for(var d in EventRegister.inputEvents)this.eventRegister.addEventListener(d,this.onDomInputEvent.bind(this),!0);this.eventRegister.addEventListener("mousedown",function(){c.focus()},!0)};return b.prototype.destruct=function(){this.eventRegister.removeAll()},b.prototype.onDomInputEvent=function(a){var b=EventRegister.inputEvents[a.type],c=new b.constructor(a.type,a);c.bubbles=b.bubbles,Input._dispatchEvent(c,this),c._defaultPrevented&&a.preventDefault(),c._propagationStopped&&(c._propagationImmediateStopped?a.stopImmediatePropagation():a.stopPropagation())},b}(),EventRegister={inputEvents:{keydown:{constructor:KeyboardEvent,bubbles:!0,cancelable:!0},keyup:{constructor:KeyboardEvent,bubbles:!0,cancelable:!0},click:{constructor:MouseEvent,bubbles:!0,cancelable:!0},dblclick:{constructor:MouseEvent,bubbles:!0,cancelable:!1},mousedown:{constructor:MouseEvent,bubbles:!0,cancelable:!0},mouseup:{constructor:MouseEvent,bubbles:!0,cancelable:!0},mousemove:{constructor:MouseEvent,bubbles:!0,cancelable:!0}}};Fire.EventRegister=EventRegister;var Input=function(){var a={_eventListeners:new EventListeners};return a.on=function(a,b){b?this._eventListeners.add(a,b):Fire.error("Callback must be non-nil")},a.off=function(a,b){b?this._eventListeners.remove(a,b)||Fire.warn("Callback not exists"):Fire.error("Callback must be non-nil")},a._reset=function(){this._eventListeners=new EventListeners},a._dispatchMouseEvent=function(a,b){var c=b.renderContext.camera||Engine._scene.camera,d=c.screenToWorld(new Vec2(a.screenX,a.screenY)),e=Engine._interactionContext.pick(d);e&&e.dispatchEvent(a)},a._dispatchEvent=function(a,b){this._eventListeners.invoke(a),a instanceof Fire.MouseEvent&&this._dispatchMouseEvent(a,b)},a}();Fire.Input=Input,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Fire),exports.Fire=Fire):"undefined"!=typeof define&&define.amd?define(Fire):root.Fire=Fire}).call(this);